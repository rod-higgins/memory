<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Memory System</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'sidebar': '#1a1625',
                        'sidebar-hover': '#2d2640',
                        'sidebar-active': '#7c3aed',
                        'content-bg': '#faf9fb',
                        'card-bg': '#ffffff',
                        'accent': '#7c3aed',
                        'accent-light': '#a78bfa',
                        'accent-dark': '#5b21b6',
                        'highlight': '#fbbf24',
                    }
                }
            }
        }
    </script>
    <style>
        [v-cloak] { display: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        .sidebar-item { transition: all 0.2s ease; }
        .sidebar-item:hover { background: rgba(124, 58, 237, 0.2); }
        .sidebar-item.active { background: #7c3aed; }
        .card { transition: all 0.2s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .chat-bubble { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .score-badge { background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c4b5fd; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #7c3aed; }
        /* Markdown content styles */
        .markdown-content h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 1rem; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        .markdown-content h2 { font-size: 1.375rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #374151; }
        .markdown-content h3 { font-size: 1.125rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; color: #4b5563; }
        .markdown-content p { margin-bottom: 0.75rem; line-height: 1.6; color: #4b5563; }
        .markdown-content ul, .markdown-content ol { margin-bottom: 0.75rem; padding-left: 1.5rem; }
        .markdown-content li { margin-bottom: 0.25rem; color: #4b5563; }
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        .markdown-content code { background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875rem; font-family: monospace; }
        .markdown-content pre { background: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1rem; }
        .markdown-content pre code { background: transparent; padding: 0; color: inherit; }
        .markdown-content table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .markdown-content th, .markdown-content td { border: 1px solid #e5e7eb; padding: 0.5rem 0.75rem; text-align: left; }
        .markdown-content th { background: #f9fafb; font-weight: 600; }
        .markdown-content a { color: #7c3aed; text-decoration: underline; }
        .markdown-content a:hover { color: #5b21b6; }
        .markdown-content blockquote { border-left: 4px solid #7c3aed; padding-left: 1rem; margin: 1rem 0; color: #6b7280; font-style: italic; }
        .markdown-content strong { font-weight: 600; color: #1f2937; }
        .markdown-content hr { border: none; border-top: 1px solid #e5e7eb; margin: 1.5rem 0; }
    </style>
</head>
<body class="bg-content-bg">
    <div id="app" v-cloak>
        <!-- Loading State -->
        <div v-if="authState === 'loading'" class="min-h-screen bg-sidebar flex items-center justify-center">
            <div class="text-center">
                <div class="w-16 h-16 bg-accent rounded-xl flex items-center justify-center mx-auto mb-4 animate-pulse">
                    <i class="fas fa-brain text-white text-2xl"></i>
                </div>
                <p class="text-gray-400">Loading...</p>
            </div>
        </div>

        <!-- Setup Required State -->
        <div v-else-if="authState === 'setup_required'" class="min-h-screen bg-sidebar flex items-center justify-center">
            <div class="bg-card-bg rounded-2xl shadow-lg p-8 w-full max-w-md text-center">
                <div class="w-16 h-16 bg-amber-500 rounded-xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Setup Required</h1>
                <p class="text-gray-600 mb-6">No admin account configured. Run the setup script to create one:</p>
                <pre class="bg-gray-100 p-4 rounded-lg text-left text-sm text-gray-700 mb-4">cd ~/memory
python scripts/setup_auth.py</pre>
                <p class="text-gray-500 text-sm">Then refresh this page.</p>
            </div>
        </div>

        <!-- Login Screen -->
        <div v-else-if="authState === 'login'" class="min-h-screen bg-sidebar flex items-center justify-center">
            <div class="bg-card-bg rounded-2xl shadow-lg p-8 w-full max-w-md">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-accent rounded-xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-brain text-white text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">Personal Memory System</h1>
                    <p class="text-gray-500 mt-2">Sign in to continue</p>
                </div>

                <form @submit.prevent="handleLogin">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Username or Email</label>
                            <input v-model="loginForm.username_or_email" type="text" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                                placeholder="Enter username or email">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input v-model="loginForm.password" type="password" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                                placeholder="Enter password">
                        </div>
                        <div v-if="authError" class="bg-red-50 text-red-600 text-sm p-3 rounded-lg">
                            <i class="fas fa-exclamation-circle mr-2"></i>{{ authError }}
                        </div>
                        <button type="submit" :disabled="authLoading"
                            class="w-full bg-accent text-white py-3 px-4 rounded-lg hover:bg-accent-dark transition font-medium disabled:opacity-50">
                            <span v-if="authLoading"><i class="fas fa-spinner fa-spin mr-2"></i>Signing in...</span>
                            <span v-else>Sign In</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MFA Setup Screen -->
        <div v-else-if="authState === 'mfa_setup'" class="min-h-screen bg-sidebar flex items-center justify-center p-4">
            <div class="bg-card-bg rounded-2xl shadow-lg p-8 w-full max-w-lg">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-accent rounded-xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-shield-alt text-white text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">Set Up Two-Factor Authentication</h1>
                    <p class="text-gray-600 mt-2">Scan this QR code with Google Authenticator or any TOTP app</p>
                </div>

                <div class="flex justify-center mb-6">
                    <img v-if="mfaSetup.qr_code_base64" :src="'data:image/png;base64,' + mfaSetup.qr_code_base64"
                        alt="MFA QR Code" class="w-48 h-48 rounded-lg border-4 border-accent-light">
                    <div v-else class="w-48 h-48 bg-gray-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                    </div>
                </div>

                <div class="bg-gray-100 rounded-lg p-4 mb-6">
                    <p class="text-sm text-gray-600 mb-2">Or enter this code manually:</p>
                    <code class="text-lg font-mono text-gray-800 break-all">{{ mfaSetup.secret }}</code>
                </div>

                <form @submit.prevent="verifyMfa" class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Enter 6-digit code from app</label>
                    <div class="flex space-x-3">
                        <input v-model="mfaCode" type="text" maxlength="6" pattern="[0-9]{6}" required
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-center text-2xl tracking-widest font-mono focus:ring-2 focus:ring-accent"
                            placeholder="000000">
                        <button type="submit" :disabled="mfaCode.length !== 6 || authLoading"
                            class="bg-accent text-white px-6 py-3 rounded-lg hover:bg-accent-dark transition font-medium disabled:opacity-50">
                            <span v-if="authLoading"><i class="fas fa-spinner fa-spin"></i></span>
                            <span v-else>Verify</span>
                        </button>
                    </div>
                    <div v-if="authError" class="mt-3 bg-red-50 text-red-600 text-sm p-3 rounded-lg">
                        <i class="fas fa-exclamation-circle mr-2"></i>{{ authError }}
                    </div>
                </form>

                <div class="bg-amber-50 rounded-lg p-4 border border-amber-200">
                    <p class="text-sm text-amber-800 font-medium mb-2"><i class="fas fa-key mr-2"></i>Backup Codes</p>
                    <p class="text-xs text-amber-700 mb-3">Save these codes in a safe place. Each can only be used once.</p>
                    <div class="grid grid-cols-2 gap-2">
                        <code v-for="code in mfaSetup.backup_codes" :key="code"
                            class="text-sm font-mono bg-white p-2 rounded text-center border border-amber-200">{{ code }}</code>
                    </div>
                </div>
            </div>
        </div>

        <!-- MFA Verify Screen (for returning users) -->
        <div v-else-if="authState === 'mfa_verify'" class="min-h-screen bg-sidebar flex items-center justify-center">
            <div class="bg-card-bg rounded-2xl shadow-lg p-8 w-full max-w-md">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-accent rounded-xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-shield-alt text-white text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">Two-Factor Authentication</h1>
                    <p class="text-gray-600 mt-2">Enter the 6-digit code from your authenticator app</p>
                </div>

                <form @submit.prevent="verifyMfa">
                    <input v-model="mfaCode" type="text" maxlength="6" pattern="[0-9]{6}" required autofocus
                        class="w-full px-4 py-4 border border-gray-300 rounded-lg text-center text-3xl tracking-widest font-mono mb-4 focus:ring-2 focus:ring-accent"
                        placeholder="000000">

                    <div v-if="authError" class="mb-4 bg-red-50 text-red-600 text-sm p-3 rounded-lg">
                        <i class="fas fa-exclamation-circle mr-2"></i>{{ authError }}
                    </div>

                    <button type="submit" :disabled="mfaCode.length !== 6 || authLoading"
                        class="w-full bg-accent text-white py-3 px-4 rounded-lg hover:bg-accent-dark transition font-medium disabled:opacity-50 mb-4">
                        <span v-if="authLoading"><i class="fas fa-spinner fa-spin mr-2"></i>Verifying...</span>
                        <span v-else>Verify</span>
                    </button>

                    <button type="button" @click="authState = 'login'; mfaCode = ''"
                        class="w-full text-gray-500 text-sm hover:text-accent">
                        <i class="fas fa-arrow-left mr-2"></i>Back to login
                    </button>
                </form>
            </div>
        </div>

        <!-- Main Application (authenticated) -->
        <div v-else-if="authState === 'authenticated'" class="flex h-screen overflow-hidden">
        <!-- Left Sidebar -->
        <aside class="w-20 bg-sidebar flex flex-col items-center py-6 flex-shrink-0">
            <!-- Logo -->
            <div class="w-12 h-12 bg-accent rounded-xl flex items-center justify-center mb-8">
                <i class="fas fa-brain text-white text-xl"></i>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 flex flex-col items-center space-y-2">
                <button @click="view = 'myai'"
                    :class="view === 'myai' ? 'active bg-highlight text-sidebar' : 'text-gray-400 hover:text-white'"
                    class="sidebar-item w-14 h-14 rounded-xl flex flex-col items-center justify-center transition">
                    <i class="fas fa-home text-lg"></i>
                    <span class="text-[10px] mt-1">My AI</span>
                </button>

                <button @click="view = 'messages'"
                    :class="view === 'messages' ? 'active text-white' : 'text-gray-400 hover:text-white'"
                    class="sidebar-item w-14 h-14 rounded-xl flex flex-col items-center justify-center transition">
                    <i class="fas fa-comment-dots text-lg"></i>
                    <span class="text-[10px] mt-1">Messages</span>
                </button>

                <button @click="view = 'memories'"
                    :class="view === 'memories' ? 'active text-white' : 'text-gray-400 hover:text-white'"
                    class="sidebar-item w-14 h-14 rounded-xl flex flex-col items-center justify-center transition">
                    <i class="fas fa-database text-lg"></i>
                    <span class="text-[10px] mt-1">Memories</span>
                </button>

                <button @click="view = 'compare'"
                    :class="view === 'compare' ? 'active text-white' : 'text-gray-400 hover:text-white'"
                    class="sidebar-item w-14 h-14 rounded-xl flex flex-col items-center justify-center transition">
                    <i class="fas fa-balance-scale text-lg"></i>
                    <span class="text-[10px] mt-1">Compare</span>
                </button>

                <button @click="view = 'connections'"
                    :class="view === 'connections' ? 'active text-white' : 'text-gray-400 hover:text-white'"
                    class="sidebar-item w-14 h-14 rounded-xl flex flex-col items-center justify-center transition">
                    <i class="fas fa-plug text-lg"></i>
                    <span class="text-[10px] mt-1">Connect</span>
                </button>

                <button @click="view = 'tools'"
                    :class="view === 'tools' ? 'active text-white' : 'text-gray-400 hover:text-white'"
                    class="sidebar-item w-14 h-14 rounded-xl flex flex-col items-center justify-center transition">
                    <i class="fas fa-tools text-lg"></i>
                    <span class="text-[10px] mt-1">AI Tools</span>
                </button>

                <button @click="view = 'llms'"
                    :class="view === 'llms' ? 'active text-white' : 'text-gray-400 hover:text-white'"
                    class="sidebar-item w-14 h-14 rounded-xl flex flex-col items-center justify-center transition">
                    <i class="fas fa-cloud text-lg"></i>
                    <span class="text-[10px] mt-1">LLMs</span>
                </button>

                <button @click="view = 'slms'"
                    :class="view === 'slms' ? 'active text-white' : 'text-gray-400 hover:text-white'"
                    class="sidebar-item w-14 h-14 rounded-xl flex flex-col items-center justify-center transition">
                    <i class="fas fa-microchip text-lg"></i>
                    <span class="text-[10px] mt-1">SLMs</span>
                </button>

                <!-- Admin (only for admin users) -->
                <button v-if="currentUser?.role === 'admin'" @click="view = 'admin'"
                    :class="view === 'admin' ? 'active text-white' : 'text-gray-400 hover:text-white'"
                    class="sidebar-item w-14 h-14 rounded-xl flex flex-col items-center justify-center transition">
                    <i class="fas fa-users-cog text-lg"></i>
                    <span class="text-[10px] mt-1">Users</span>
                </button>
            </nav>

        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Search Bar -->
            <header class="bg-sidebar h-14 flex items-center px-6 flex-shrink-0">
                <div class="flex-1 max-w-2xl mx-auto">
                    <div class="relative">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" v-model="searchQuery" @keyup.enter="performSearch"
                            placeholder="Search memories, conversations..."
                            class="w-full bg-sidebar-hover text-white placeholder-gray-400 rounded-full py-2.5 pl-11 pr-16 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-xs bg-gray-700 px-2 py-0.5 rounded">⌘K</span>
                    </div>
                </div>
                <button @click="openHelp()" class="ml-4 text-gray-400 hover:text-white" title="Help">
                    <i class="fas fa-question-circle text-lg"></i>
                </button>

                <!-- User Avatar & Dropdown -->
                <div class="ml-4 relative">
                    <button @click="showUserMenu = !showUserMenu"
                        class="flex items-center space-x-2 hover:bg-sidebar-hover rounded-lg px-2 py-1 transition">
                        <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-bold">{{ currentUser?.username?.charAt(0)?.toUpperCase() || '?' }}</span>
                        </div>
                        <span class="text-gray-300 text-sm hidden sm:inline">{{ currentUser?.username }}</span>
                        <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                    </button>

                    <!-- Dropdown Backdrop (closes menu on click) -->
                    <div v-if="showUserMenu" @click="showUserMenu = false" class="fixed inset-0 z-40"></div>

                    <!-- Dropdown Menu -->
                    <div v-if="showUserMenu"
                        class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg py-2 z-50">
                        <div class="px-4 py-2 border-b border-gray-100">
                            <p class="text-sm font-medium text-gray-800">{{ currentUser?.username }}</p>
                            <p class="text-xs text-gray-500">{{ currentUser?.email }}</p>
                        </div>
                        <button @click="showChangePasswordModal = true; showUserMenu = false"
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center">
                            <i class="fas fa-key w-5 text-gray-400"></i>
                            Change Password
                        </button>
                        <button @click="handleLogout"
                            class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center">
                            <i class="fas fa-sign-out-alt w-5"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <main class="flex-1 overflow-auto">
                <!-- My AI View -->
                <div v-if="view === 'myai'" class="p-8">
                    <div class="max-w-6xl mx-auto">
                        <h1 class="text-2xl font-bold text-gray-800 mb-6">My AI</h1>

                        <!-- Profile Card -->
                        <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-100 p-8 mb-8">
                            <div class="flex items-center space-x-6">
                                <div class="w-24 h-24 bg-gradient-to-br from-accent to-accent-light rounded-2xl flex items-center justify-center">
                                    <i class="fas fa-user text-white text-4xl"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-gray-800">Personal Memory System</h2>
                                    <p class="text-gray-500 mt-1">Your AI-powered memory assistant</p>
                                    <div class="flex items-center mt-3 space-x-4">
                                        <span class="score-badge text-white text-sm px-3 py-1 rounded-full">
                                            <i class="fas fa-check-circle mr-1"></i> {{ stats.total_memories || 0 }} memories
                                        </span>
                                        <span class="bg-green-100 text-green-700 text-sm px-3 py-1 rounded-full">
                                            <i class="fas fa-circle text-xs mr-1"></i> Active
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-100 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Total Memories</p>
                                        <p class="text-3xl font-bold text-gray-800 mt-1">{{ stats.total_memories || 0 }}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-brain text-accent text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-100 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Short-term</p>
                                        <p class="text-3xl font-bold text-amber-500 mt-1">{{ stats.by_tier?.short_term || 0 }}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-clock text-amber-500 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-100 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Long-term</p>
                                        <p class="text-3xl font-bold text-blue-500 mt-1">{{ stats.by_tier?.long_term || 0 }}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-archive text-blue-500 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-100 p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Persistent</p>
                                        <p class="text-3xl font-bold text-green-500 mt-1">{{ stats.by_tier?.persistent || 0 }}</p>
                                    </div>
                                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-gem text-green-500 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-100 p-6 mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Recent Activity</h3>
                                <button @click="view = 'memories'" class="text-accent hover:text-accent-dark text-sm font-medium">
                                    View All <i class="fas fa-arrow-right ml-1"></i>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div v-for="activity in (stats.recent_activity || []).slice(0, 5)" :key="activity.id"
                                    class="flex items-start gap-3 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition cursor-pointer"
                                    @click="view = 'memories'">
                                    <div class="w-8 h-8 bg-accent/10 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-brain text-accent text-sm"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm text-gray-800 truncate">{{ activity.content }}</p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            <span class="capitalize">{{ activity.type }}</span> · {{ formatDate(activity.created_at) }}
                                        </p>
                                    </div>
                                </div>
                                <p v-if="!stats.recent_activity?.length" class="text-gray-400 text-center py-4">
                                    No recent activity
                                </p>
                            </div>
                        </div>

                        <!-- Knowledge Domains -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-100 p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Memory Types</h3>
                                <div class="space-y-3">
                                    <div v-for="(count, type) in stats.by_type" :key="type" class="flex items-center">
                                        <span class="w-20 text-sm text-gray-600 capitalize">{{ type }}</span>
                                        <div class="flex-1 bg-gray-100 rounded-full h-3 mx-3">
                                            <div class="bg-gradient-to-r from-accent to-accent-light h-3 rounded-full transition-all"
                                                :style="{width: Math.min((count / stats.total_memories * 100), 100) + '%'}"></div>
                                        </div>
                                        <span class="text-sm font-medium text-gray-700 w-12 text-right">{{ count }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-100 p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Top Domains</h3>
                                <div class="space-y-2">
                                    <div v-for="domain in (stats.top_domains || []).slice(0, 6)" :key="domain.domain"
                                        @click="filterDomain = domain.domain; view = 'memories'; loadMemories(true);"
                                        class="flex items-center justify-between py-2 border-b border-gray-50 cursor-pointer hover:bg-gray-50 rounded px-2 -mx-2 transition">
                                        <span class="text-gray-700 hover:text-accent">{{ domain.domain }}</span>
                                        <span class="text-accent font-medium">{{ domain.count }}</span>
                                    </div>
                                    <p v-if="!stats.top_domains?.length" class="text-gray-400 text-center py-4">
                                        No domain data yet
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages/Chat View -->
                <div v-if="view === 'messages'" class="flex h-full">
                    <!-- Channels List -->
                    <div class="w-80 bg-card-bg border-r border-gray-200 flex flex-col">
                        <div class="p-6 border-b border-gray-100">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-bold text-gray-800">Messages</h2>
                                <button class="w-8 h-8 bg-accent text-white rounded-lg hover:bg-accent-dark transition">
                                    <i class="fas fa-pen text-sm"></i>
                                </button>
                            </div>
                            <!-- Tabs -->
                            <div class="flex space-x-4">
                                <button @click="chatTab = 'all'"
                                    :class="chatTab === 'all' ? 'text-accent border-b-2 border-accent' : 'text-gray-500'"
                                    class="pb-2 text-sm font-medium">
                                    All <span class="ml-1 text-xs bg-gray-200 px-1.5 py-0.5 rounded-full">{{ conversations.length }}</span>
                                </button>
                                <button @click="chatTab = 'channels'"
                                    :class="chatTab === 'channels' ? 'text-accent border-b-2 border-accent' : 'text-gray-500'"
                                    class="pb-2 text-sm font-medium">Channels</button>
                            </div>
                        </div>

                        <!-- Conversation List -->
                        <div class="flex-1 overflow-y-auto">
                            <div v-for="conv in conversations" :key="conv.id"
                                @click="selectConversation(conv)"
                                :class="selectedConversation?.id === conv.id ? 'bg-purple-50 border-l-4 border-accent' : 'hover:bg-gray-50'"
                                class="flex items-center px-4 py-3 cursor-pointer transition">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white text-sm font-bold mr-3"
                                    :class="conv.color || 'bg-accent'">
                                    {{ conv.initials }}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <span class="font-medium text-gray-800 truncate">{{ conv.name }}</span>
                                        <span v-if="conv.unread" class="bg-accent text-white text-xs px-2 py-0.5 rounded-full">{{ conv.unread }}</span>
                                    </div>
                                    <p class="text-sm text-gray-500 truncate">{{ conv.lastMessage }}</p>
                                </div>
                            </div>

                            <!-- Empty state -->
                            <div v-if="!conversations.length" class="text-center py-12 text-gray-400">
                                <i class="fas fa-comments text-4xl mb-3"></i>
                                <p>No conversations yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div class="flex-1 flex flex-col bg-content-bg">
                        <div v-if="selectedConversation" class="flex-1 flex flex-col">
                            <!-- Chat Header -->
                            <div class="bg-card-bg border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white text-sm font-bold mr-3"
                                        :class="selectedConversation.color || 'bg-accent'">
                                        {{ selectedConversation.initials }}
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-800">{{ selectedConversation.name }}</h3>
                                        <p class="text-xs text-gray-500">personal-ai.local</p>
                                    </div>
                                </div>
                                <!-- LLM Selector -->
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-500">Model:</label>
                                    <select v-model="selectedLLM"
                                        class="bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                                        <option v-for="llm in availableLLMs" :key="llm.id" :value="llm.id">
                                            {{ llm.name }}
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <!-- Messages -->
                            <div class="flex-1 overflow-y-auto p-6 space-y-4">
                                <div v-for="msg in chatMessages" :key="msg.id" class="chat-bubble">
                                    <div class="flex items-start space-x-3" :class="msg.isUser ? 'flex-row-reverse space-x-reverse' : ''">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0"
                                            :class="msg.isUser ? 'bg-gray-200' : 'bg-accent'">
                                            <i :class="msg.isUser ? 'fas fa-user text-gray-600' : 'fas fa-robot text-white'"></i>
                                        </div>
                                        <div :class="msg.isUser ? 'text-right' : ''">
                                            <div class="flex items-center space-x-2" :class="msg.isUser ? 'flex-row-reverse space-x-reverse' : ''">
                                                <span class="font-medium text-gray-800">{{ msg.sender }}</span>
                                                <span class="text-xs text-gray-400">{{ msg.time }}</span>
                                                <span v-if="!msg.isUser" class="text-xs text-green-600 flex items-center">
                                                    <i class="fas fa-check-circle mr-1"></i>{{ msg.score }}% personal score
                                                </span>
                                            </div>
                                            <div class="mt-1 p-4 rounded-2xl max-w-xl"
                                                :class="msg.isUser ? 'bg-accent text-white rounded-tr-none' : 'bg-white border border-gray-100 rounded-tl-none shadow-sm'">
                                                <p class="text-sm whitespace-pre-wrap">{{ msg.content }}</p>
                                            </div>
                                            <p v-if="!msg.isUser && msg.autopilot" class="text-xs text-gray-400 mt-1 flex items-center">
                                                <i class="fas fa-circle text-blue-400 mr-1 text-[6px]"></i> Sent with PLM Context
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Message Input -->
                            <div class="bg-card-bg border-t border-gray-200 p-4">
                                <div class="flex items-center space-x-3">
                                    <input type="text" v-model="newMessage" @keyup.enter="sendMessage"
                                        :disabled="chatLoading"
                                        placeholder="Type your message..."
                                        class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent disabled:opacity-50">
                                    <button @click="sendMessage" :disabled="chatLoading"
                                        class="bg-accent hover:bg-accent-dark disabled:bg-gray-300 text-white px-6 py-3 rounded-xl transition">
                                        <i v-if="!chatLoading" class="fas fa-paper-plane"></i>
                                        <i v-else class="fas fa-spinner fa-spin"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- No conversation selected -->
                        <div v-else class="flex-1 flex items-center justify-center">
                            <div class="text-center text-gray-400">
                                <i class="fas fa-comments text-6xl mb-4"></i>
                                <p class="text-lg">Select a conversation to start chatting</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Memories View -->
                <div v-if="view === 'memories'" class="p-8">
                    <div class="max-w-7xl mx-auto">
                        <!-- Header with Search -->
                        <div class="flex items-center justify-between mb-6">
                            <h1 class="text-2xl font-bold text-gray-800">Memories</h1>
                            <button @click="showAddModal = true" class="bg-accent hover:bg-accent-dark text-white px-4 py-2 rounded-xl text-sm transition">
                                <i class="fas fa-plus mr-2"></i>Add Memory
                            </button>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-card-bg rounded-xl p-4 border border-gray-100">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-gray-500 uppercase tracking-wide">Total</p>
                                        <p class="text-2xl font-bold text-gray-800">{{ stats.total_memories || 0 }}</p>
                                    </div>
                                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-brain text-accent"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-card-bg rounded-xl p-4 border border-gray-100 border-l-4 border-l-amber-400">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Short-term</p>
                                <p class="text-2xl font-bold text-amber-600">{{ stats.by_tier?.short_term || 0 }}</p>
                            </div>
                            <div class="bg-card-bg rounded-xl p-4 border border-gray-100 border-l-4 border-l-blue-400">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Long-term</p>
                                <p class="text-2xl font-bold text-blue-600">{{ stats.by_tier?.long_term || 0 }}</p>
                            </div>
                            <div class="bg-card-bg rounded-xl p-4 border border-gray-100 border-l-4 border-l-green-400">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Persistent</p>
                                <p class="text-2xl font-bold text-green-600">{{ stats.by_tier?.persistent || 0 }}</p>
                            </div>
                        </div>

                        <!-- Search and Filters -->
                        <div class="bg-card-bg rounded-2xl p-4 border border-gray-100 mb-6">
                            <div class="flex flex-col md:flex-row md:items-center gap-4">
                                <!-- Search -->
                                <div class="flex-1 relative">
                                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" v-model="memorySearch" @input="filterMemories"
                                        placeholder="Search memories..."
                                        class="w-full bg-gray-50 border border-gray-200 rounded-xl py-2.5 pl-11 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                                </div>
                                <!-- Filters -->
                                <div class="flex items-center gap-3">
                                    <select v-model="filterTier" @change="setTierFilter($event.target.value)"
                                        class="bg-gray-50 border border-gray-200 rounded-xl px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                                        <option value="">All Tiers</option>
                                        <option value="SHORT_TERM">Short-term</option>
                                        <option value="LONG_TERM">Long-term</option>
                                        <option value="PERSISTENT">Persistent</option>
                                    </select>
                                    <select v-model="filterDomain" @change="setDomainFilter($event.target.value)"
                                        class="bg-gray-50 border border-gray-200 rounded-xl px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                                        <option value="">All Domains</option>
                                        <option v-for="domain in topDomains" :key="domain" :value="domain">{{ domain }}</option>
                                    </select>
                                    <button @click="loadMemories" class="bg-gray-100 hover:bg-gray-200 p-2.5 rounded-xl transition">
                                        <i class="fas fa-sync-alt text-gray-600"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Domain Tags -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            <button @click="setDomainFilter('')"
                                :class="!filterDomain ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                class="px-3 py-1.5 rounded-full text-sm font-medium transition">
                                All
                            </button>
                            <button v-for="domain in (stats.top_domains || []).slice(0, 8)" :key="domain.domain"
                                @click="setDomainFilter(domain.domain)"
                                :class="filterDomain === domain.domain ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                class="px-3 py-1.5 rounded-full text-sm font-medium transition">
                                {{ domain.domain }} <span class="opacity-70">({{ domain.count }})</span>
                            </button>
                        </div>

                        <!-- Results Count & Page Size -->
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-sm text-gray-500">
                                Showing {{ showingFrom }}-{{ showingTo }} of {{ totalMemories }} memories
                                <span v-if="memorySearch"> ({{ filteredMemories.length }} matching "{{ memorySearch }}")</span>
                            </p>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-500">Per page:</label>
                                <select :value="pageSize" @change="changePageSize($event.target.value)"
                                    class="bg-gray-50 border border-gray-200 rounded-lg px-2 py-1 text-sm">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>

                        <!-- Memory Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="memory in filteredMemories" :key="memory.id"
                                class="card bg-card-bg rounded-2xl p-5 border border-gray-100 cursor-pointer hover:border-accent/30"
                                @click="viewMemory(memory)">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-medium px-2.5 py-1 rounded-full"
                                            :class="{
                                                'bg-amber-100 text-amber-700': memory.tier === 'SHORT_TERM',
                                                'bg-blue-100 text-blue-700': memory.tier === 'LONG_TERM',
                                                'bg-green-100 text-green-700': memory.tier === 'PERSISTENT'
                                            }">
                                            {{ memory.tier?.replace('_', ' ') }}
                                        </span>
                                        <span v-if="memory.memory_type" class="text-xs text-gray-400">{{ memory.memory_type }}</span>
                                    </div>
                                    <span class="text-xs text-gray-400">{{ formatDate(memory.created_at) }}</span>
                                </div>

                                <!-- Summary or Content -->
                                <p v-if="memory.summary" class="text-gray-800 text-sm font-medium mb-1">{{ memory.summary }}</p>
                                <p class="text-gray-600 text-sm line-clamp-3">{{ memory.content?.substring(0, 200) }}...</p>

                                <!-- Domains -->
                                <div v-if="memory.domains?.length" class="flex flex-wrap gap-1.5 mt-3">
                                    <span v-for="domain in memory.domains.slice(0, 3)" :key="domain"
                                        class="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full">
                                        {{ domain }}
                                    </span>
                                </div>

                                <!-- Tags -->
                                <div v-if="memory.tags?.length" class="flex flex-wrap gap-1.5 mt-2">
                                    <span v-for="tag in memory.tags.slice(0, 3)" :key="tag"
                                        class="text-xs bg-purple-50 text-accent px-2 py-0.5 rounded-full">
                                        #{{ tag }}
                                    </span>
                                    <span v-if="memory.tags.length > 3" class="text-xs text-gray-400">
                                        +{{ memory.tags.length - 3 }} more
                                    </span>
                                </div>

                                <!-- Confidence -->
                                <div class="mt-3 pt-3 border-t border-gray-50 flex items-center justify-between">
                                    <div class="flex items-center gap-1">
                                        <div class="w-16 bg-gray-100 rounded-full h-1.5">
                                            <div class="bg-accent h-1.5 rounded-full" :style="{width: ((memory.confidence?.overall || 0.8) * 100) + '%'}"></div>
                                        </div>
                                        <span class="text-xs text-gray-400">{{ Math.round((memory.confidence?.overall || 0.8) * 100) }}%</span>
                                    </div>
                                    <span v-if="memory.access_count" class="text-xs text-gray-400">
                                        <i class="fas fa-eye mr-1"></i>{{ memory.access_count }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div v-if="!filteredMemories.length && memories.length" class="text-center py-16">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-search text-gray-400 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">No matches found</h3>
                            <p class="text-gray-500">Try adjusting your search or filters</p>
                        </div>

                        <!-- Pagination Controls -->
                        <div v-if="totalPages > 1" class="flex items-center justify-center gap-2 mt-8">
                            <!-- Previous -->
                            <button @click="prevPage" :disabled="currentPage === 1 || memoriesLoading"
                                class="px-3 py-2 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition">
                                <i class="fas fa-chevron-left"></i>
                            </button>

                            <!-- Page Numbers -->
                            <template v-for="page in pageNumbers" :key="page">
                                <span v-if="page === '...'" class="px-2 text-gray-400">...</span>
                                <button v-else @click="goToPage(page)" :disabled="memoriesLoading"
                                    :class="page === currentPage
                                        ? 'bg-accent text-white'
                                        : 'bg-white border border-gray-200 text-gray-700 hover:bg-gray-50'"
                                    class="w-10 h-10 rounded-lg font-medium transition disabled:opacity-50">
                                    {{ page }}
                                </button>
                            </template>

                            <!-- Next -->
                            <button @click="nextPage" :disabled="currentPage === totalPages || memoriesLoading"
                                class="px-3 py-2 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>

                        <!-- Loading Overlay -->
                        <div v-if="memoriesLoading" class="fixed inset-0 bg-black/10 flex items-center justify-center z-40 pointer-events-none">
                            <div class="bg-white rounded-xl shadow-lg p-4 flex items-center gap-3">
                                <i class="fas fa-spinner fa-spin text-accent text-xl"></i>
                                <span class="text-gray-700">Loading memories...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compare View -->
                <div v-if="view === 'compare'" class="p-8">
                    <div class="max-w-6xl mx-auto">
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">LLM Comparison</h1>
                        <p class="text-gray-500 mb-6">See how different AI models respond with and without your personal context</p>

                        <!-- Provider Status -->
                        <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4">Available Providers</h3>
                            <div class="flex flex-wrap gap-3">
                                <div v-for="provider in compareProviders" :key="provider.id"
                                    class="flex items-center px-4 py-2 rounded-xl border"
                                    :class="provider.available ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'">
                                    <i class="fas fa-circle text-xs mr-2" :class="provider.available ? 'text-green-500' : 'text-gray-400'"></i>
                                    <span class="font-medium" :class="provider.available ? 'text-green-700' : 'text-gray-500'">{{ provider.name }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Query Input -->
                        <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Question</label>
                            <textarea v-model="compareQuery" rows="2"
                                placeholder="e.g., What programming languages am I good at?"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-accent resize-none"></textarea>
                            <div class="flex items-center justify-between mt-4">
                                <div class="flex items-center space-x-2">
                                    <label class="text-sm text-gray-600">Context entries:</label>
                                    <input type="number" v-model.number="compareMaxMemories" min="1" max="20"
                                        class="w-16 bg-gray-50 border border-gray-200 rounded-lg px-2 py-1 text-sm text-center">
                                </div>
                                <button @click="runComparison" :disabled="!compareQuery || comparing"
                                    class="bg-accent hover:bg-accent-dark disabled:bg-gray-300 text-white px-6 py-2 rounded-xl transition flex items-center">
                                    <i class="fas fa-play mr-2" v-if="!comparing"></i>
                                    <i class="fas fa-spinner fa-spin mr-2" v-else></i>
                                    {{ comparing ? 'Comparing...' : 'Run Comparison' }}
                                </button>
                            </div>
                        </div>

                        <!-- Results -->
                        <div v-if="compareResults" class="space-y-6">
                            <!-- Context Preview -->
                            <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-100 p-6">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-semibold text-gray-800">
                                        <i class="fas fa-user-circle text-accent mr-2"></i>
                                        PLM Context Used ({{ compareResults.context_length }} chars)
                                    </h3>
                                    <button @click="showFullContext = !showFullContext" class="text-accent text-sm">
                                        {{ showFullContext ? 'Collapse' : 'Expand' }}
                                    </button>
                                </div>
                                <pre class="text-xs bg-gray-50 p-4 rounded-xl overflow-x-auto text-gray-600"
                                    :class="showFullContext ? '' : 'max-h-24 overflow-y-hidden'">{{ compareResults.context_preview }}</pre>
                            </div>

                            <!-- Side by Side Results -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- With Context -->
                                <div class="bg-card-bg rounded-2xl shadow-sm border border-green-200 overflow-hidden">
                                    <div class="bg-green-50 px-6 py-3 border-b border-green-200">
                                        <h3 class="font-semibold text-green-800">
                                            <i class="fas fa-check-circle mr-2"></i>With PLM Context
                                        </h3>
                                    </div>
                                    <div class="p-6 space-y-4">
                                        <div v-for="(result, provider) in compareResults.with_context" :key="'with-' + provider"
                                            class="border-b border-gray-100 pb-4 last:border-0 last:pb-0">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="font-medium text-gray-800">{{ provider }}</span>
                                                <span class="text-xs text-gray-400">{{ result.latency_ms }}ms</span>
                                            </div>
                                            <p v-if="result.error" class="text-red-500 text-sm">{{ result.error }}</p>
                                            <p v-else class="text-gray-600 text-sm whitespace-pre-wrap">{{ result.response }}</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Without Context -->
                                <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                                        <h3 class="font-semibold text-gray-600">
                                            <i class="fas fa-times-circle mr-2"></i>Without Context
                                        </h3>
                                    </div>
                                    <div class="p-6 space-y-4">
                                        <div v-for="(result, provider) in compareResults.without_context" :key="'without-' + provider"
                                            class="border-b border-gray-100 pb-4 last:border-0 last:pb-0">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="font-medium text-gray-800">{{ provider }}</span>
                                                <span class="text-xs text-gray-400">{{ result.latency_ms }}ms</span>
                                            </div>
                                            <p v-if="result.error" class="text-red-500 text-sm">{{ result.error }}</p>
                                            <p v-else class="text-gray-600 text-sm whitespace-pre-wrap">{{ result.response }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div v-if="!compareResults && !comparing" class="text-center py-16">
                            <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-balance-scale text-accent text-3xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">Compare AI Responses</h3>
                            <p class="text-gray-500 max-w-md mx-auto">
                                Enter a question above to see how different AI models respond with and without your personal memory context.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Connections View -->
                <div v-if="view === 'connections'" class="p-8">
                    <div class="max-w-5xl mx-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h1 class="text-2xl font-bold text-gray-800">Data Connections</h1>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-gray-500">{{ connections.length }} connected sources</span>
                                <button @click="loadConnections" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-lg transition">
                                    <i class="fas fa-sync-alt text-gray-600"></i>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="conn in connections" :key="conn.id"
                                class="card bg-card-bg rounded-2xl p-5 border border-gray-100">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center"
                                        :class="conn.status === 'connected' ? 'bg-green-100' : 'bg-gray-100'">
                                        <i :class="getConnectionIcon(conn.source_id)"
                                            :class="conn.status === 'connected' ? 'text-green-600' : 'text-gray-400'" class="text-xl"></i>
                                    </div>
                                    <span class="px-2.5 py-1 rounded-full text-xs font-medium"
                                        :class="conn.status === 'connected' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'">
                                        {{ conn.status }}
                                    </span>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-1">{{ conn.name }}</h3>
                                <p class="text-sm text-gray-500 mb-3">{{ conn.source_id }}</p>
                                <div class="flex items-center justify-between text-xs text-gray-400">
                                    <span v-if="conn.last_sync">
                                        <i class="fas fa-sync-alt mr-1"></i>
                                        {{ formatDate(conn.last_sync) }}
                                    </span>
                                    <span v-if="conn.sync_enabled" class="text-green-500">
                                        <i class="fas fa-check-circle mr-1"></i>Auto-sync
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div v-if="!connections.length" class="text-center py-16">
                            <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-plug text-accent text-3xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">No Connections</h3>
                            <p class="text-gray-500">Set up data connections to start building your memory.</p>
                        </div>
                    </div>
                </div>

                <!-- AI Tools View -->
                <div v-if="view === 'tools'" class="p-8">
                    <div class="max-w-4xl mx-auto">
                        <h1 class="text-2xl font-bold text-gray-800 mb-6">AI Tools</h1>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div @click="view = 'compare'" class="card bg-card-bg rounded-2xl p-6 border border-gray-100 cursor-pointer">
                                <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center mb-4">
                                    <i class="fas fa-balance-scale text-accent text-2xl"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-2">LLM Comparison</h3>
                                <p class="text-gray-500 text-sm">Compare how different AI models respond with and without your context.</p>
                            </div>

                            <div @click="showContextGenerator = true" class="card bg-card-bg rounded-2xl p-6 border border-gray-100 cursor-pointer hover:border-blue-300 transition">
                                <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center mb-4">
                                    <i class="fas fa-code text-blue-600 text-2xl"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-2">Context Generator</h3>
                                <p class="text-gray-500 text-sm">Generate context blocks for any LLM conversation.</p>
                            </div>

                            <div @click="showIngestion = true; loadSources();" class="card bg-card-bg rounded-2xl p-6 border border-gray-100 cursor-pointer hover:border-green-300 transition">
                                <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center mb-4">
                                    <i class="fas fa-upload text-green-600 text-2xl"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-2">Data Ingestion</h3>
                                <p class="text-gray-500 text-sm">Import data from various sources into your memory.</p>
                            </div>

                            <div @click="showSynthesis = true; runSynthesis();" class="card bg-card-bg rounded-2xl p-6 border border-gray-100 cursor-pointer hover:border-amber-300 transition">
                                <div class="w-14 h-14 bg-amber-100 rounded-xl flex items-center justify-center mb-4">
                                    <i class="fas fa-lightbulb text-amber-600 text-2xl"></i>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-2">Knowledge Synthesis</h3>
                                <p class="text-gray-500 text-sm">Extract and synthesize insights from your memories.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LLMs View -->
                <div v-if="view === 'llms'" class="p-8">
                    <div class="max-w-5xl mx-auto">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">Cloud LLMs</h1>
                                <p class="text-gray-500 mt-1">Manage cloud-based language models (Claude, GPT, etc.)</p>
                            </div>
                            <button @click="showAddLLMModal = true" class="bg-accent hover:bg-accent-dark text-white px-4 py-2 rounded-xl text-sm transition">
                                <i class="fas fa-plus mr-2"></i>Add LLM
                            </button>
                        </div>

                        <!-- LLM Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="llm in llmModels" :key="llm.id"
                                class="card bg-card-bg rounded-2xl p-5 border border-gray-100">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center"
                                        :class="llm.enabled ? 'bg-green-100' : 'bg-gray-100'">
                                        <i :class="getLLMIcon(llm.provider)" class="text-xl"
                                            :class="llm.enabled ? 'text-green-600' : 'text-gray-400'"></i>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span v-if="llm.enabled" class="px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                            Active
                                        </span>
                                        <span v-else class="px-2.5 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-700">
                                            Not Configured
                                        </span>
                                    </div>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-1">{{ llm.name }}</h3>
                                <p class="text-sm text-gray-500 mb-2">{{ llm.model }}</p>
                                <p v-if="llm.description" class="text-xs text-gray-400 mb-3">{{ llm.description }}</p>
                                <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                                    <div class="flex items-center gap-2">
                                        <button @click="editLLM(llm)" class="text-xs px-2 py-1 rounded-lg bg-accent/10 text-accent hover:bg-accent/20 transition">
                                            <i class="fas fa-cog mr-1"></i>Configure
                                        </button>
                                        <button @click="testLLM(llm)" class="text-xs px-2 py-1 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition">
                                            Test
                                        </button>
                                    </div>
                                    <button v-if="!llm.built_in" @click="deleteLLM(llm)" class="text-gray-400 hover:text-red-500 transition">
                                        <i class="fas fa-trash text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div v-if="!llmModels.length" class="text-center py-16">
                            <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-cloud text-accent text-3xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">No Cloud LLMs Configured</h3>
                            <p class="text-gray-500 mb-4">Add cloud-based language models to use in conversations and comparisons.</p>
                            <button @click="showAddLLMModal = true" class="bg-accent hover:bg-accent-dark text-white px-6 py-2 rounded-xl transition">
                                <i class="fas fa-plus mr-2"></i>Add Your First LLM
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SLMs View -->
                <div v-if="view === 'slms'" class="p-8">
                    <div class="max-w-5xl mx-auto">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">Local SLMs</h1>
                                <p class="text-gray-500 mt-1">Run open-source language models locally via Ollama</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button @click="refreshOllamaModels" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-xl text-sm transition">
                                    <i class="fas fa-sync-alt mr-2" :class="slmRefreshing ? 'fa-spin' : ''"></i>Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Ollama Status -->
                        <div class="bg-card-bg rounded-2xl p-4 border border-gray-100 mb-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center"
                                        :class="ollamaStatus.running ? 'bg-green-100' : 'bg-red-100'">
                                        <i class="fas fa-server" :class="ollamaStatus.running ? 'text-green-600' : 'text-red-500'"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">Ollama Server</p>
                                        <p class="text-sm" :class="ollamaStatus.running ? 'text-green-600' : 'text-red-500'">
                                            {{ ollamaStatus.running ? 'Running at ' + ollamaStatus.url : 'Not running - run "ollama serve"' }}
                                        </p>
                                    </div>
                                </div>
                                <div v-if="ollamaStatus.running" class="text-sm text-gray-500">
                                    {{ ollamaStatus.models_count }} models installed
                                </div>
                            </div>
                        </div>

                        <!-- Installed Models -->
                        <div v-if="slmModels.length" class="mb-8">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>Installed Models
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div v-for="slm in slmModels" :key="slm.id"
                                    class="card bg-card-bg rounded-2xl p-5 border border-gray-100">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="w-12 h-12 rounded-xl flex items-center justify-center bg-green-100">
                                            <i class="fas fa-microchip text-xl text-green-600"></i>
                                        </div>
                                        <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                            Ready
                                        </span>
                                    </div>
                                    <h3 class="font-semibold text-gray-800 mb-1">{{ slm.name }}</h3>
                                    <p class="text-sm text-gray-500 mb-2">{{ slm.model }}</p>
                                    <p v-if="slm.size" class="text-xs text-gray-400 mb-3">
                                        <i class="fas fa-hdd mr-1"></i>{{ formatSize(slm.size) }}
                                    </p>
                                    <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                                        <div class="flex items-center gap-2">
                                            <button @click="testSLM(slm)" class="text-xs px-3 py-1.5 rounded-lg bg-green-100 text-green-700 hover:bg-green-200 transition">
                                                <i class="fas fa-play mr-1"></i>Test
                                            </button>
                                        </div>
                                        <button @click="deleteOllamaModel(slm.model)" class="text-gray-400 hover:text-red-500 transition" title="Remove model">
                                            <i class="fas fa-trash text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Available Open-Source Models -->
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">
                                <i class="fas fa-download text-blue-500 mr-2"></i>Available Open-Source Models
                            </h2>
                            <p class="text-sm text-gray-500 mb-4">Click "Install" to download and run these models locally. All models are open-source.</p>

                            <!-- Category Filter -->
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button @click="modelCategory = 'all'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition"
                                    :class="modelCategory === 'all' ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                    All Models
                                </button>
                                <button @click="modelCategory = 'qwen'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition"
                                    :class="modelCategory === 'qwen' ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                    Qwen
                                </button>
                                <button @click="modelCategory = 'llama'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition"
                                    :class="modelCategory === 'llama' ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                    Llama
                                </button>
                                <button @click="modelCategory = 'phi'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition"
                                    :class="modelCategory === 'phi' ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                    Phi
                                </button>
                                <button @click="modelCategory = 'gemma'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition"
                                    :class="modelCategory === 'gemma' ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                    Gemma
                                </button>
                                <button @click="modelCategory = 'mistral'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition"
                                    :class="modelCategory === 'mistral' ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                    Mistral
                                </button>
                                <button @click="modelCategory = 'code'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition"
                                    :class="modelCategory === 'code' ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                    <i class="fas fa-code mr-1"></i>Code
                                </button>
                                <button @click="modelCategory = 'other'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition"
                                    :class="modelCategory === 'other' ? 'bg-accent text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                                    Other
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div v-for="model in filteredAvailableModels" :key="model.name"
                                    class="bg-card-bg rounded-xl p-4 border border-gray-100 flex items-center justify-between">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <h3 class="font-medium text-gray-800 truncate">{{ model.display_name }}</h3>
                                            <span v-if="model.installed" class="px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-600 whitespace-nowrap">
                                                Installed
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-500 mb-1 truncate">{{ model.description }}</p>
                                        <div class="flex items-center gap-3 text-xs text-gray-400">
                                            <span><i class="fas fa-hdd mr-1"></i>{{ model.size }}</span>
                                            <span class="truncate"><i class="fas fa-balance-scale mr-1"></i>{{ model.license }}</span>
                                        </div>
                                    </div>
                                    <button v-if="!model.installed && !pullingModels[model.name]"
                                        @click="pullOllamaModel(model.name)"
                                        :disabled="!ollamaStatus.running"
                                        class="ml-3 px-3 py-1.5 rounded-lg text-sm font-medium transition flex-shrink-0"
                                        :class="ollamaStatus.running ? 'bg-accent hover:bg-accent-dark text-white' : 'bg-gray-200 text-gray-400 cursor-not-allowed'">
                                        <i class="fas fa-download mr-1"></i>Install
                                    </button>
                                    <div v-else-if="pullingModels[model.name]" class="ml-3 px-3 py-1.5 text-sm text-blue-600 flex-shrink-0">
                                        <i class="fas fa-spinner fa-spin mr-1"></i>Installing...
                                    </div>
                                    <span v-else class="ml-3 text-green-500 flex-shrink-0">
                                        <i class="fas fa-check-circle text-lg"></i>
                                    </span>
                                </div>
                            </div>

                            <p v-if="filteredAvailableModels.length === 0" class="text-center text-gray-400 py-8">
                                No models found in this category.
                            </p>
                        </div>

                        <!-- Empty State when Ollama not running -->
                        <div v-if="!ollamaStatus.running" class="text-center py-12 mt-8 bg-amber-50 rounded-2xl border border-amber-200">
                            <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-exclamation-triangle text-amber-600 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-800 mb-2">Ollama Not Running</h3>
                            <p class="text-gray-600 mb-4">Start the Ollama server to install and run local models.</p>
                            <code class="bg-gray-800 text-green-400 px-4 py-2 rounded-lg text-sm">ollama serve</code>
                        </div>
                    </div>
                </div>

                <!-- Admin User Management View -->
                <div v-if="view === 'admin' && currentUser?.role === 'admin'" class="p-8">
                    <div class="max-w-6xl mx-auto">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">User Management</h1>
                                <p class="text-gray-500 mt-1">Manage user accounts and permissions</p>
                            </div>
                            <button @click="showAddUserModal = true"
                                class="bg-accent hover:bg-accent-dark text-white px-4 py-2 rounded-xl transition">
                                <i class="fas fa-plus mr-2"></i>Add User
                            </button>
                        </div>

                        <!-- Users Table -->
                        <div class="bg-card-bg rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b border-gray-100">
                                    <tr>
                                        <th class="text-left px-6 py-4 text-sm font-medium text-gray-600">User</th>
                                        <th class="text-left px-6 py-4 text-sm font-medium text-gray-600">Role</th>
                                        <th class="text-left px-6 py-4 text-sm font-medium text-gray-600">Status</th>
                                        <th class="text-left px-6 py-4 text-sm font-medium text-gray-600">MFA</th>
                                        <th class="text-left px-6 py-4 text-sm font-medium text-gray-600">Last Login</th>
                                        <th class="text-right px-6 py-4 text-sm font-medium text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="user in adminUsers" :key="user.id" class="border-b border-gray-50 hover:bg-gray-50">
                                        <td class="px-6 py-4">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center">
                                                    <span class="text-white font-bold">{{ user.username.charAt(0).toUpperCase() }}</span>
                                                </div>
                                                <div>
                                                    <div class="font-medium text-gray-800">{{ user.username }}</div>
                                                    <div class="text-sm text-gray-500">{{ user.email }}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span :class="user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'"
                                                class="px-2 py-1 rounded-full text-xs font-medium">
                                                {{ user.role }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span :class="user.is_active ? 'text-green-600' : 'text-red-500'" class="flex items-center">
                                                <i :class="user.is_active ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-1"></i>
                                                {{ user.is_active ? 'Active' : 'Inactive' }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span :class="user.mfa_enabled ? 'text-green-600' : 'text-amber-500'">
                                                <i :class="user.mfa_enabled ? 'fas fa-shield-alt' : 'fas fa-exclamation-triangle'" class="text-lg"></i>
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 text-gray-500 text-sm">
                                            {{ user.last_login ? formatDate(user.last_login) : 'Never' }}
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <button @click="openEditUser(user)" class="text-blue-500 hover:text-blue-700 mr-3" title="Edit User">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button @click="resetUserMfa(user)" class="text-amber-500 hover:text-amber-700 mr-3" title="Reset MFA">
                                                <i class="fas fa-key"></i>
                                            </button>
                                            <button @click="toggleUserStatus(user)"
                                                :class="user.is_active ? 'text-red-500 hover:text-red-700' : 'text-green-500 hover:text-green-700'"
                                                :title="user.is_active ? 'Deactivate' : 'Activate'"
                                                :disabled="user.id === currentUser.id">
                                                <i :class="user.is_active ? 'fas fa-user-slash' : 'fas fa-user-check'"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="adminUsers.length === 0">
                                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                            <i class="fas fa-users text-4xl mb-3 opacity-30"></i>
                                            <p>No users found</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Add Memory Modal -->
        <div v-if="showAddModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showAddModal = false">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">Save to Memory</h2>
                    <button @click="showAddModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                        <textarea v-model="newMemory.content" rows="4"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-accent resize-none"
                            placeholder="What would you like to remember?"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Memory Tier</label>
                        <div class="flex gap-2">
                            <button @click="newMemory.tier = 'short_term'"
                                :class="newMemory.tier === 'short_term' ? 'bg-amber-100 border-amber-400 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                class="flex-1 px-3 py-2 rounded-xl border text-sm font-medium transition">
                                <i class="fas fa-clock mr-1"></i> Short-term
                            </button>
                            <button @click="newMemory.tier = 'long_term'"
                                :class="newMemory.tier === 'long_term' ? 'bg-blue-100 border-blue-400 text-blue-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                class="flex-1 px-3 py-2 rounded-xl border text-sm font-medium transition">
                                <i class="fas fa-archive mr-1"></i> Long-term
                            </button>
                            <button @click="newMemory.tier = 'persistent'"
                                :class="newMemory.tier === 'persistent' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                class="flex-1 px-3 py-2 rounded-xl border text-sm font-medium transition">
                                <i class="fas fa-gem mr-1"></i> Persistent
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            <span v-if="newMemory.tier === 'short_term'">Temporary memory (in-memory only, lost on restart)</span>
                            <span v-else-if="newMemory.tier === 'long_term'">Stored with vector embeddings for semantic search</span>
                            <span v-else>Permanently stored in database</span>
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span v-for="(tag, i) in newMemory.tags" :key="i"
                                class="bg-purple-100 text-accent px-3 py-1 rounded-full text-sm flex items-center">
                                #{{ tag }}
                                <button @click="newMemory.tags.splice(i, 1)" class="ml-2 text-accent-dark">&times;</button>
                            </span>
                        </div>
                        <input type="text" v-model="newTag" @keyup.enter="addTag"
                            placeholder="Add tags..."
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm">
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                    <button @click="showAddModal = false" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button @click="saveMemory" class="bg-accent hover:bg-accent-dark text-white px-6 py-2 rounded-xl transition">
                        Save to Memory
                    </button>
                </div>
            </div>
        </div>

        <!-- Context Generator Modal -->
        <div v-if="showContextGenerator" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showContextGenerator = false">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl mx-4 max-h-[80vh] flex flex-col">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-code text-blue-600 mr-2"></i>Context Generator
                    </h2>
                    <button @click="showContextGenerator = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6 flex-1 overflow-auto">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-600">Max memories:</label>
                            <input type="number" v-model.number="contextMaxMemories" min="5" max="50"
                                class="w-20 bg-gray-50 border border-gray-200 rounded-lg px-2 py-1 text-sm">
                        </div>
                        <button @click="generateContext" :disabled="contextLoading"
                            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white px-4 py-2 rounded-lg text-sm transition">
                            <i class="fas fa-sync-alt mr-1" :class="contextLoading ? 'fa-spin' : ''"></i>
                            {{ contextLoading ? 'Generating...' : 'Generate Context' }}
                        </button>
                        <button @click="copyContext" v-if="generatedContext" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm transition">
                            <i class="fas fa-copy mr-1"></i>Copy
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">This generates a context block from your memories that you can use with any LLM.</p>
                    <pre v-if="generatedContext" class="bg-gray-50 p-4 rounded-xl text-sm text-gray-700 whitespace-pre-wrap font-mono overflow-auto max-h-96">{{ generatedContext }}</pre>
                    <div v-else class="bg-gray-50 p-8 rounded-xl text-center text-gray-400">
                        Click "Generate Context" to create a context block from your memories
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Ingestion Modal -->
        <div v-if="showIngestion" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showIngestion = false">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl mx-4 max-h-[80vh] flex flex-col">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-upload text-green-600 mr-2"></i>Data Ingestion
                    </h2>
                    <button @click="showIngestion = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6 flex-1 overflow-auto">
                    <p class="text-sm text-gray-500 mb-4">Import data from connected sources into your memory system.</p>
                    <div class="space-y-3">
                        <div v-for="source in ingestionSources" :key="source.id"
                            class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center border">
                                    <i :class="getConnectionIcon(source.id)" class="text-gray-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800">{{ source.name }}</h4>
                                    <p class="text-xs text-gray-500">{{ source.description }}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span v-if="ingestionStatus[source.id]?.message" class="text-xs"
                                    :class="ingestionStatus[source.id].success ? 'text-green-600' : 'text-gray-500'">
                                    {{ ingestionStatus[source.id].message }}
                                </span>
                                <button @click="runIngestion(source.id)"
                                    :disabled="ingestionStatus[source.id]?.loading"
                                    class="bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white px-3 py-1.5 rounded-lg text-sm transition">
                                    <i class="fas fa-download mr-1" :class="ingestionStatus[source.id]?.loading ? 'fa-spin fa-spinner' : ''"></i>
                                    {{ ingestionStatus[source.id]?.loading ? 'Importing...' : 'Import' }}
                                </button>
                            </div>
                        </div>
                        <div v-if="!ingestionSources.length" class="text-center py-8 text-gray-400">
                            <i class="fas fa-plug text-3xl mb-2"></i>
                            <p>No sources configured. Set up connections first.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Knowledge Synthesis Modal -->
        <div v-if="showSynthesis" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showSynthesis = false">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl mx-4 max-h-[80vh] flex flex-col">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-lightbulb text-amber-600 mr-2"></i>Knowledge Synthesis
                    </h2>
                    <button @click="showSynthesis = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6 flex-1 overflow-auto">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm text-gray-500">Analyze your memories to extract key insights and patterns.</p>
                        <button @click="runSynthesis" :disabled="synthesisLoading"
                            class="bg-amber-600 hover:bg-amber-700 disabled:bg-gray-300 text-white px-4 py-2 rounded-lg text-sm transition">
                            <i class="fas fa-sync-alt mr-1" :class="synthesisLoading ? 'fa-spin' : ''"></i>
                            {{ synthesisLoading ? 'Analyzing...' : 'Run Synthesis' }}
                        </button>
                    </div>

                    <div v-if="synthesisLoading" class="text-center py-12">
                        <i class="fas fa-spinner fa-spin text-4xl text-amber-500 mb-4"></i>
                        <p class="text-gray-500">Analyzing your memories...</p>
                    </div>

                    <div v-else-if="synthesisResult" class="space-y-6">
                        <!-- Skills -->
                        <div v-if="synthesisResult.skills?.length" class="bg-blue-50 p-4 rounded-xl">
                            <h4 class="font-semibold text-blue-800 mb-2"><i class="fas fa-tools mr-2"></i>Skills Identified</h4>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="skill in synthesisResult.skills" :key="skill"
                                    class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">{{ skill }}</span>
                            </div>
                        </div>

                        <!-- Topics -->
                        <div v-if="synthesisResult.topics?.length" class="bg-green-50 p-4 rounded-xl">
                            <h4 class="font-semibold text-green-800 mb-2"><i class="fas fa-tags mr-2"></i>Key Topics</h4>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="topic in synthesisResult.topics" :key="topic"
                                    class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">{{ topic }}</span>
                            </div>
                        </div>

                        <!-- Summary -->
                        <div v-if="synthesisResult.summary" class="bg-amber-50 p-4 rounded-xl">
                            <h4 class="font-semibold text-amber-800 mb-2"><i class="fas fa-lightbulb mr-2"></i>Summary</h4>
                            <p class="text-amber-900 text-sm">{{ synthesisResult.summary }}</p>
                        </div>

                        <!-- Stats -->
                        <div v-if="synthesisResult.stats" class="bg-gray-50 p-4 rounded-xl">
                            <h4 class="font-semibold text-gray-800 mb-2"><i class="fas fa-chart-bar mr-2"></i>Memory Analysis</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div>
                                    <p class="text-2xl font-bold text-gray-800">{{ synthesisResult.stats.total || 0 }}</p>
                                    <p class="text-xs text-gray-500">Total Memories</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-gray-800">{{ synthesisResult.stats.domains || 0 }}</p>
                                    <p class="text-xs text-gray-500">Domains</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-gray-800">{{ synthesisResult.stats.entities || 0 }}</p>
                                    <p class="text-xs text-gray-500">Entities</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-gray-800">{{ synthesisResult.stats.connections || 0 }}</p>
                                    <p class="text-xs text-gray-500">Connections</p>
                                </div>
                            </div>
                        </div>

                        <!-- Error -->
                        <div v-if="synthesisResult.error" class="bg-red-50 p-4 rounded-xl">
                            <p class="text-red-700"><i class="fas fa-exclamation-circle mr-2"></i>{{ synthesisResult.error }}</p>
                        </div>
                    </div>

                    <div v-else class="text-center py-12 text-gray-400">
                        <i class="fas fa-lightbulb text-4xl mb-4"></i>
                        <p>Click "Run Synthesis" to analyze your memories</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add LLM Modal -->
        <div v-if="showAddLLMModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showAddLLMModal = false">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-cloud text-accent mr-2"></i>Add Cloud LLM
                    </h2>
                    <button @click="showAddLLMModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                        <input type="text" v-model="newLLM.name" placeholder="e.g., Claude 3.5 Sonnet"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Provider</label>
                        <select v-model="newLLM.provider"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="">Select provider...</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="openai">OpenAI (GPT)</option>
                            <option value="google">Google (Gemini)</option>
                            <option value="cohere">Cohere</option>
                            <option value="mistral">Mistral AI</option>
                            <option value="bedrock">AWS Bedrock</option>
                            <option value="azure">Azure OpenAI</option>
                            <option value="custom">Custom API</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model ID</label>
                        <input type="text" v-model="newLLM.model" placeholder="e.g., claude-3-5-sonnet-20241022"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                        <input type="password" v-model="newLLM.api_key" placeholder="sk-..."
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                        <p class="text-xs text-gray-400 mt-1">Stored securely. Leave blank to use environment variable.</p>
                    </div>
                    <div v-if="newLLM.provider === 'custom'">
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Base URL</label>
                        <input type="text" v-model="newLLM.base_url" placeholder="https://api.example.com/v1"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
                        <input type="text" v-model="newLLM.description" placeholder="Best for coding tasks..."
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                    <button @click="showAddLLMModal = false" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button @click="saveLLM" :disabled="!newLLM.name || !newLLM.provider || !newLLM.model"
                        class="bg-accent hover:bg-accent-dark disabled:bg-gray-300 text-white px-6 py-2 rounded-xl transition">
                        Add LLM
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit LLM Modal -->
        <div v-if="showEditLLMModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showEditLLMModal = false">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-cog text-accent mr-2"></i>Configure {{ editingLLM?.name }}
                    </h2>
                    <button @click="showEditLLMModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div v-if="editingLLM?.built_in" class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <p class="text-sm text-blue-700">
                            <i class="fas fa-info-circle mr-2"></i>
                            This is a built-in provider. Configure the API key to enable it.
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                        <input type="text" v-model="editingLLM.name" :disabled="editingLLM?.built_in"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent disabled:opacity-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                        <input type="text" v-model="editingLLM.model"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                        <input type="password" v-model="editingLLM.api_key" :placeholder="editingLLM?.built_in ? 'Enter API key to enable...' : 'sk-...'"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                        <p class="text-xs text-gray-400 mt-1">
                            {{ editingLLM?.built_in ? 'Required to enable this provider.' : 'Leave blank to keep existing key.' }}
                        </p>
                    </div>
                    <div v-if="!editingLLM?.built_in">
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Base URL (optional)</label>
                        <input type="text" v-model="editingLLM.base_url" placeholder="https://api.example.com/v1"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div v-if="!editingLLM?.built_in">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <input type="text" v-model="editingLLM.description"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div v-if="!editingLLM?.built_in" class="flex items-center justify-between py-2">
                        <span class="text-sm text-gray-700">Enabled</span>
                        <button @click="editingLLM.enabled = !editingLLM.enabled"
                            :class="editingLLM?.enabled ? 'bg-accent' : 'bg-gray-300'"
                            class="w-12 h-6 rounded-full relative transition-colors">
                            <span :class="editingLLM?.enabled ? 'right-1' : 'left-1'"
                                class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all"></span>
                        </button>
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                    <button @click="showEditLLMModal = false" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button @click="updateLLM" class="bg-accent hover:bg-accent-dark text-white px-6 py-2 rounded-xl transition">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- Add SLM Modal -->
        <div v-if="showAddSLMModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showAddSLMModal = false">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-microchip text-blue-600 mr-2"></i>Add Local SLM
                    </h2>
                    <button @click="showAddSLMModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                        <input type="text" v-model="newSLM.name" placeholder="e.g., Llama 3.2 3B"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Runtime</label>
                        <select v-model="newSLM.runtime"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="">Select runtime...</option>
                            <option value="ollama">Ollama</option>
                            <option value="lmstudio">LM Studio</option>
                            <option value="llamacpp">llama.cpp</option>
                            <option value="vllm">vLLM</option>
                            <option value="custom">Custom Endpoint</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model Name</label>
                        <div class="flex gap-2">
                            <input type="text" v-model="newSLM.model" placeholder="e.g., llama3.2:3b"
                                class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                            <button v-if="newSLM.runtime === 'ollama'" @click="loadOllamaModelsList"
                                class="bg-gray-100 hover:bg-gray-200 px-3 rounded-xl transition" title="Load from Ollama">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div v-if="ollamaModelsList.length" class="mt-2 flex flex-wrap gap-1">
                            <button v-for="m in ollamaModelsList.slice(0, 6)" :key="m"
                                @click="newSLM.model = m; newSLM.name = m.split(':')[0].charAt(0).toUpperCase() + m.split(':')[0].slice(1)"
                                class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full hover:bg-blue-100 transition">
                                {{ m }}
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Endpoint</label>
                        <input type="text" v-model="newSLM.endpoint" :placeholder="newSLM.runtime === 'ollama' ? 'http://localhost:11434' : 'http://localhost:1234/v1'"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                        <p class="text-xs text-gray-400 mt-1">Leave blank for default endpoint.</p>
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                    <button @click="showAddSLMModal = false" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button @click="saveSLM" :disabled="!newSLM.name || !newSLM.runtime || !newSLM.model"
                        class="bg-accent hover:bg-accent-dark disabled:bg-gray-300 text-white px-6 py-2 rounded-xl transition">
                        Add SLM
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit SLM Modal -->
        <div v-if="showEditSLMModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showEditSLMModal = false">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-cog text-blue-600 mr-2"></i>Configure {{ editingSLM?.name }}
                    </h2>
                    <button @click="showEditSLMModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                        <input type="text" v-model="editingSLM.name"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Runtime</label>
                        <select v-model="editingSLM.runtime"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="ollama">Ollama</option>
                            <option value="lmstudio">LM Studio</option>
                            <option value="llamacpp">llama.cpp</option>
                            <option value="vllm">vLLM</option>
                            <option value="custom">Custom Endpoint</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model Name</label>
                        <div class="flex gap-2">
                            <input type="text" v-model="editingSLM.model"
                                class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                            <button v-if="editingSLM?.runtime === 'ollama'" @click="loadOllamaModelsList"
                                class="bg-gray-100 hover:bg-gray-200 px-3 rounded-xl transition" title="Load from Ollama">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div v-if="ollamaModelsList.length && editingSLM?.runtime === 'ollama'" class="mt-2 flex flex-wrap gap-1">
                            <button v-for="m in ollamaModelsList.slice(0, 6)" :key="m"
                                @click="editingSLM.model = m"
                                class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full hover:bg-blue-100 transition">
                                {{ m }}
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Endpoint</label>
                        <input type="text" v-model="editingSLM.endpoint"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-accent">
                    </div>
                    <div class="flex items-center justify-between py-2">
                        <span class="text-sm text-gray-700">Enabled</span>
                        <button @click="editingSLM.enabled = !editingSLM.enabled"
                            :class="editingSLM?.enabled ? 'bg-green-500' : 'bg-gray-300'"
                            class="w-12 h-6 rounded-full relative transition-colors">
                            <span :class="editingSLM?.enabled ? 'right-1' : 'left-1'"
                                class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all"></span>
                        </button>
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-gray-100 flex justify-end space-x-3">
                    <button @click="showEditSLMModal = false" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button @click="updateSLM" class="bg-accent hover:bg-accent-dark text-white px-6 py-2 rounded-xl transition">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Result Modal -->
        <div v-if="showTestResult" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showTestResult = false">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-vial mr-2" :class="testResult.success ? 'text-green-600' : 'text-red-500'"></i>
                        Test Result
                    </h2>
                    <button @click="showTestResult = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div v-if="testResult.loading" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-accent mb-4"></i>
                        <p class="text-gray-500">Testing connection...</p>
                    </div>
                    <div v-else-if="testResult.success" class="text-center py-4">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check text-green-600 text-2xl"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 mb-2">Connection Successful!</h3>
                        <p class="text-sm text-gray-500 mb-4">{{ testResult.message }}</p>
                        <div v-if="testResult.response" class="bg-gray-50 p-3 rounded-xl text-left">
                            <p class="text-xs text-gray-400 mb-1">Response:</p>
                            <p class="text-sm text-gray-700">{{ testResult.response }}</p>
                        </div>
                        <p v-if="testResult.latency" class="text-xs text-gray-400 mt-2">Latency: {{ testResult.latency }}ms</p>
                    </div>
                    <div v-else class="text-center py-4">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-times text-red-500 text-2xl"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 mb-2">Connection Failed</h3>
                        <p class="text-sm text-red-500">{{ testResult.error }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add User Modal -->
        <div v-if="showAddUserModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showAddUserModal = false">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-user-plus mr-2 text-accent"></i>Add New User
                    </h2>
                    <button @click="showAddUserModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form @submit.prevent="createUser" class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input v-model="newUserForm.username" type="text" required minlength="3"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                            placeholder="Enter username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input v-model="newUserForm.email" type="email" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                            placeholder="user@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input v-model="newUserForm.password" type="password" required minlength="8"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                            placeholder="Minimum 8 characters">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                        <select v-model="newUserForm.role"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-700">
                        <i class="fas fa-info-circle mr-2"></i>
                        User will be required to set up two-factor authentication on first login.
                    </div>
                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" @click="showAddUserModal = false"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button type="submit"
                            class="bg-accent hover:bg-accent-dark text-white px-6 py-2 rounded-xl transition">
                            Create User
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div v-if="showChangePasswordModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showChangePasswordModal = false">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-key mr-2 text-accent"></i>Change Password
                    </h2>
                    <button @click="showChangePasswordModal = false; passwordError = ''; passwordSuccess = false; passwordForm.current = ''; passwordForm.new = ''; passwordForm.confirm = '';" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form @submit.prevent="changePassword" class="p-6 space-y-4">
                    <div v-if="passwordSuccess" class="bg-green-50 p-4 rounded-lg text-green-700 text-center">
                        <i class="fas fa-check-circle mr-2"></i>Password changed successfully!
                    </div>
                    <div v-if="passwordError" class="bg-red-50 p-4 rounded-lg text-red-600 text-sm">
                        {{ passwordError }}
                    </div>
                    <div v-if="!passwordSuccess">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                        <input v-model="passwordForm.current" type="password" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                            placeholder="Enter current password">
                    </div>
                    <div v-if="!passwordSuccess">
                        <label class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                        <input v-model="passwordForm.new" type="password" required minlength="8"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                            placeholder="Minimum 8 characters">
                    </div>
                    <div v-if="!passwordSuccess">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                        <input v-model="passwordForm.confirm" type="password" required minlength="8"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                            placeholder="Confirm new password">
                    </div>
                    <div class="flex justify-end space-x-3 pt-2">
                        <button type="button" @click="showChangePasswordModal = false; passwordError = ''; passwordSuccess = false; passwordForm.current = ''; passwordForm.new = ''; passwordForm.confirm = '';"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800">{{ passwordSuccess ? 'Close' : 'Cancel' }}</button>
                        <button v-if="!passwordSuccess" type="submit"
                            class="bg-accent hover:bg-accent-dark text-white px-6 py-2 rounded-xl transition">
                            Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit User Modal -->
        <div v-if="showEditUserModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="closeEditUserModal">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-user-edit mr-2 text-accent"></i>Edit User
                    </h2>
                    <button @click="closeEditUserModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div v-if="editUserError" class="bg-red-50 p-3 rounded-lg text-red-600 text-sm">
                        {{ editUserError }}
                    </div>
                    <div v-if="editUserSuccess" class="bg-green-50 p-3 rounded-lg text-green-700 text-sm">
                        {{ editUserSuccess }}
                    </div>

                    <!-- User Info (non-editable) -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-accent rounded-full flex items-center justify-center">
                                <span class="text-white text-xl font-bold">{{ editUserForm.username?.charAt(0).toUpperCase() }}</span>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">{{ editUserForm.username }}</div>
                                <div class="text-sm text-gray-500">ID: {{ editUserForm.id?.substring(0, 8) }}...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Editable Fields -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input v-model="editUserForm.email" type="email" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                            placeholder="user@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                        <select v-model="editUserForm.role"
                            :disabled="editUserForm.id === currentUser?.id"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                        <p v-if="editUserForm.id === currentUser?.id" class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>You cannot change your own role
                        </p>
                    </div>

                    <!-- Save Changes Button -->
                    <button @click="saveUserChanges"
                        class="w-full bg-accent hover:bg-accent-dark text-white px-4 py-2 rounded-xl transition">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>

                    <!-- Divider -->
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Security Actions</h3>
                    </div>

                    <!-- Reset Password Section -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reset Password</label>
                        <div class="flex space-x-2">
                            <input v-model="editUserNewPassword" type="password"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent"
                                placeholder="New password (min 8 chars)" minlength="8">
                            <button @click="resetUserPassword"
                                :disabled="!editUserNewPassword || editUserNewPassword.length < 8"
                                class="bg-amber-500 hover:bg-amber-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-4 py-2 rounded-xl transition whitespace-nowrap">
                                <i class="fas fa-key mr-1"></i>Reset
                            </button>
                        </div>
                    </div>

                    <!-- Reset MFA -->
                    <button @click="resetEditUserMfa"
                        class="w-full bg-amber-50 hover:bg-amber-100 text-amber-700 border border-amber-200 px-4 py-2 rounded-xl transition">
                        <i class="fas fa-shield-alt mr-2"></i>Reset Two-Factor Authentication
                    </button>

                    <!-- Deactivate/Activate -->
                    <button v-if="editUserForm.id !== currentUser?.id" @click="toggleEditUserStatus"
                        :class="editUserForm.is_active ? 'bg-red-50 hover:bg-red-100 text-red-700 border-red-200' : 'bg-green-50 hover:bg-green-100 text-green-700 border-green-200'"
                        class="w-full border px-4 py-2 rounded-xl transition">
                        <i :class="editUserForm.is_active ? 'fas fa-user-slash' : 'fas fa-user-check'" class="mr-2"></i>
                        {{ editUserForm.is_active ? 'Deactivate User' : 'Activate User' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div v-if="showHelpModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="closeHelp">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl mx-4 max-h-[85vh] flex flex-col">
                <!-- Header -->
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100 flex-shrink-0">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-book-open text-accent text-xl"></i>
                        <h2 class="text-lg font-semibold text-gray-800">Help & Documentation</h2>
                    </div>
                    <button @click="closeHelp" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex flex-1 overflow-hidden">
                    <!-- Sidebar -->
                    <div class="w-56 bg-gray-50 border-r border-gray-100 p-4 flex-shrink-0 overflow-y-auto">
                        <nav class="space-y-1">
                            <button
                                v-for="page in helpPages"
                                :key="page.id"
                                @click="loadHelpPage(page.id)"
                                :class="[
                                    'w-full text-left px-3 py-2 rounded-lg text-sm transition',
                                    currentHelpPage?.id === page.id
                                        ? 'bg-accent text-white'
                                        : 'text-gray-700 hover:bg-gray-100'
                                ]">
                                {{ page.title }}
                            </button>
                        </nav>
                    </div>

                    <!-- Content Area -->
                    <div class="flex-1 p-6 overflow-y-auto">
                        <div v-if="helpLoading" class="flex items-center justify-center h-full">
                            <i class="fas fa-spinner fa-spin text-accent text-2xl"></i>
                        </div>
                        <div v-else-if="currentHelpPage" class="markdown-content" v-html="currentHelpPage.html"></div>
                        <div v-else class="text-center text-gray-500 py-12">
                            <i class="fas fa-book text-4xl mb-4"></i>
                            <p>Select a topic from the menu to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="flex items-center justify-between px-6 py-3 border-t border-gray-100 bg-gray-50 rounded-b-2xl flex-shrink-0">
                    <a href="https://github.com/rod-higgins/memory/issues" target="_blank" class="text-sm text-gray-500 hover:text-accent">
                        <i class="fas fa-bug mr-1"></i> Report an Issue
                    </a>
                    <button @click="closeHelp" class="px-4 py-1.5 text-sm text-gray-600 hover:text-gray-800">Close</button>
                </div>
            </div>
        </div>
        </div><!-- End authenticated state wrapper -->
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed, watch } = Vue;

        createApp({
            setup() {
                // Auth State
                const authState = ref('loading'); // loading, login, mfa_setup, mfa_verify, authenticated, setup_required
                const authLoading = ref(false);
                const authError = ref('');
                const currentUser = ref(null);
                const showUserMenu = ref(false);
                const loginForm = reactive({ username_or_email: '', password: '' });
                const mfaSetup = reactive({ secret: '', qr_code_base64: '', backup_codes: [] });
                const mfaCode = ref('');

                // Admin State
                const adminUsers = ref([]);
                const showAddUserModal = ref(false);
                const newUserForm = reactive({ username: '', email: '', password: '', role: 'user' });

                // Password Change State
                const showChangePasswordModal = ref(false);
                const passwordForm = reactive({ current: '', new: '', confirm: '' });
                const passwordError = ref('');
                const passwordSuccess = ref(false);

                // Edit User State
                const showEditUserModal = ref(false);
                const editUserForm = reactive({ id: '', username: '', email: '', role: '', is_active: true });
                const editUserNewPassword = ref('');
                const editUserError = ref('');
                const editUserSuccess = ref('');

                // Help System State
                const showHelpModal = ref(false);
                const helpPages = ref([]);
                const currentHelpPage = ref(null);
                const helpLoading = ref(false);

                // State
                const view = ref('myai');
                const searchQuery = ref('');
                const stats = ref({});
                const memories = ref([]);
                const connections = ref([]);
                const showAddModal = ref(false);
                const filterTier = ref('');
                const filterType = ref('');
                const filterDomain = ref('');
                const memorySearch = ref('');

                // Pagination state
                const currentPage = ref(1);
                const pageSize = ref(25);
                const totalMemories = ref(0);
                const memoriesLoading = ref(false);

                // Computed
                const topDomains = computed(() => {
                    return (stats.value.top_domains || []).map(d => d.domain);
                });

                const filteredMemories = computed(() => {
                    let result = memories.value;
                    if (memorySearch.value) {
                        const search = memorySearch.value.toLowerCase();
                        result = result.filter(m =>
                            (m.content && m.content.toLowerCase().includes(search)) ||
                            (m.summary && m.summary.toLowerCase().includes(search)) ||
                            (m.tags && m.tags.some(t => t.toLowerCase().includes(search)))
                        );
                    }
                    return result;
                });

                const filteredAvailableModels = computed(() => {
                    if (modelCategory.value === 'all') return availableModels.value;
                    if (modelCategory.value === 'code') {
                        // Show all code-focused models
                        return availableModels.value.filter(m =>
                            m.name.includes('coder') || m.name.includes('code') ||
                            m.category === 'starcoder' || m.category === 'deepseek'
                        );
                    }
                    return availableModels.value.filter(m => m.category === modelCategory.value);
                });

                // Pagination computed
                const totalPages = computed(() => Math.ceil(totalMemories.value / pageSize.value) || 1);
                const showingFrom = computed(() => ((currentPage.value - 1) * pageSize.value) + 1);
                const showingTo = computed(() => Math.min(currentPage.value * pageSize.value, totalMemories.value));
                const pageNumbers = computed(() => {
                    const pages = [];
                    const total = totalPages.value;
                    const current = currentPage.value;

                    if (total <= 7) {
                        for (let i = 1; i <= total; i++) pages.push(i);
                    } else {
                        pages.push(1);
                        if (current > 3) pages.push('...');
                        for (let i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) {
                            pages.push(i);
                        }
                        if (current < total - 2) pages.push('...');
                        pages.push(total);
                    }
                    return pages;
                });

                // Chat state
                const chatTab = ref('all');
                const selectedLLM = ref('claude');
                const availableLLMs = ref([]);
                const conversations = ref([
                    { id: 1, name: 'AI Assistant', initials: 'AI', color: 'bg-accent', lastMessage: 'How can I help you today?', unread: 0 }
                ]);
                const selectedConversation = ref(null);
                const chatMessages = ref([]);
                const newMessage = ref('');
                const chatLoading = ref(false);

                // Compare state
                const compareProviders = ref([]);
                const compareQuery = ref('');
                const compareMaxMemories = ref(10);
                const compareResults = ref(null);
                const comparing = ref(false);
                const showFullContext = ref(false);

                // Add memory state
                const newMemory = reactive({ content: '', tags: [], tier: 'persistent' });
                const newTag = ref('');

                // Tool modals state
                const showContextGenerator = ref(false);
                const showIngestion = ref(false);
                const showSynthesis = ref(false);
                const generatedContext = ref('');
                const contextLoading = ref(false);
                const contextMaxMemories = ref(20);
                const ingestionSources = ref([]);
                const ingestionStatus = ref({});
                const synthesisResult = ref(null);
                const synthesisLoading = ref(false);

                // LLM/SLM state
                const llmModels = ref([]);
                const slmModels = ref([]);
                const showAddLLMModal = ref(false);
                const showAddSLMModal = ref(false);
                const showEditLLMModal = ref(false);
                const showEditSLMModal = ref(false);
                const editingLLM = ref(null);
                const editingSLM = ref(null);
                const newLLM = reactive({ name: '', provider: '', model: '', api_key: '', base_url: '', description: '' });
                const newSLM = reactive({ name: '', runtime: '', model: '', endpoint: '' });
                const ollamaStatus = ref({ running: false, url: 'http://localhost:11434', models_count: 0 });
                const ollamaModelsList = ref([]);
                const slmRefreshing = ref(false);
                const availableModels = ref([]);
                const pullingModels = reactive({});
                const modelCategory = ref('all');
                const showTestResult = ref(false);
                const testResult = ref({ loading: false, success: false, message: '', error: '', response: '', latency: null });

                // Methods
                const loadStats = async () => {
                    try {
                        const res = await fetch('/api/stats');
                        stats.value = await res.json();
                    } catch (e) { console.error('Error loading stats:', e); }
                };

                const loadMemories = async (resetPage = false) => {
                    if (resetPage) currentPage.value = 1;
                    memoriesLoading.value = true;
                    try {
                        const offset = (currentPage.value - 1) * pageSize.value;
                        let url = `/api/memories?limit=${pageSize.value}&offset=${offset}`;
                        if (filterTier.value) url += `&tier=${filterTier.value}`;
                        if (filterDomain.value) url += `&domain=${filterDomain.value}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        memories.value = data.memories || data || [];
                        totalMemories.value = data.total || data.count || memories.value.length;
                    } catch (e) { console.error('Error loading memories:', e); }
                    finally { memoriesLoading.value = false; }
                };

                const filterMemories = () => {
                    // Filtering is handled by computed property
                };

                const setDomainFilter = async (domain) => {
                    filterDomain.value = domain;
                    await loadMemories(true);
                };

                const setTierFilter = async (tier) => {
                    filterTier.value = tier;
                    await loadMemories(true);
                };

                // Pagination methods
                const goToPage = async (page) => {
                    if (page === '...' || page < 1 || page > totalPages.value) return;
                    currentPage.value = page;
                    await loadMemories();
                };

                const prevPage = async () => {
                    if (currentPage.value > 1) {
                        currentPage.value--;
                        await loadMemories();
                    }
                };

                const nextPage = async () => {
                    if (currentPage.value < totalPages.value) {
                        currentPage.value++;
                        await loadMemories();
                    }
                };

                const changePageSize = async (size) => {
                    pageSize.value = parseInt(size);
                    await loadMemories(true);
                };

                const loadConnections = async () => {
                    try {
                        const res = await fetch('/api/connections');
                        const data = await res.json();
                        connections.value = data.connections || data || [];
                    } catch (e) { console.error('Error loading connections:', e); }
                };

                const loadProviders = async () => {
                    try {
                        const res = await fetch('/api/compare/providers');
                        const data = await res.json();
                        compareProviders.value = data.providers || [];
                        availableLLMs.value = (data.providers || []).filter(p => p.available);
                    } catch (e) { console.error('Error loading providers:', e); }
                };

                const runComparison = async () => {
                    if (!compareQuery.value || comparing.value) return;
                    comparing.value = true;
                    compareResults.value = null;
                    try {
                        const res = await fetch('/api/compare', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: compareQuery.value,
                                max_memories: compareMaxMemories.value
                            })
                        });
                        compareResults.value = await res.json();
                    } catch (e) {
                        console.error('Error running comparison:', e);
                    } finally {
                        comparing.value = false;
                    }
                };

                const selectConversation = (conv) => {
                    selectedConversation.value = conv;
                    chatMessages.value = [
                        { id: 1, sender: 'AI Assistant', content: 'Hello! I\'m your personal AI assistant. How can I help you today?', time: 'Now', score: 96, autopilot: true }
                    ];
                };

                const sendMessage = async () => {
                    if (!newMessage.value.trim() || chatLoading.value) return;

                    const userMsg = {
                        id: Date.now(),
                        sender: 'You',
                        content: newMessage.value,
                        time: 'Now',
                        isUser: true
                    };
                    chatMessages.value.push(userMsg);

                    const query = newMessage.value;
                    newMessage.value = '';
                    chatLoading.value = true;

                    try {
                        // Use compare/single endpoint with selected LLM
                        const res = await fetch('/api/compare/single', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: query,
                                provider: selectedLLM.value,
                                max_memories: 10
                            })
                        });
                        const data = await res.json();

                        const llmName = availableLLMs.value.find(l => l.id === selectedLLM.value)?.name || 'AI Assistant';
                        chatMessages.value.push({
                            id: Date.now() + 1,
                            sender: llmName,
                            content: data.error || data.response,
                            time: 'Now',
                            score: data.error ? 0 : 94,
                            autopilot: true,
                            latency: data.latency_ms
                        });
                    } catch (e) {
                        console.error('Error sending message:', e);
                        chatMessages.value.push({
                            id: Date.now() + 1,
                            sender: 'System',
                            content: 'Error: Could not get response from AI',
                            time: 'Now',
                            score: 0
                        });
                    } finally {
                        chatLoading.value = false;
                    }
                };

                const saveMemory = async () => {
                    if (!newMemory.content) return;
                    try {
                        await fetch('/api/memories', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newMemory)
                        });
                        showAddModal.value = false;
                        newMemory.content = '';
                        newMemory.tags = [];
                        newMemory.tier = 'persistent';
                        loadMemories(true);
                        loadStats();
                    } catch (e) { console.error('Error saving memory:', e); }
                };

                const addTag = () => {
                    if (newTag.value && !newMemory.tags.includes(newTag.value)) {
                        newMemory.tags.push(newTag.value);
                        newTag.value = '';
                    }
                };

                // Context Generator
                const generateContext = async () => {
                    contextLoading.value = true;
                    try {
                        const res = await fetch(`/api/context?max_memories=${contextMaxMemories.value}`);
                        const data = await res.json();
                        generatedContext.value = data.context || 'No context generated';
                    } catch (e) {
                        generatedContext.value = 'Error generating context: ' + e.message;
                    } finally {
                        contextLoading.value = false;
                    }
                };

                const copyContext = () => {
                    navigator.clipboard.writeText(generatedContext.value);
                };

                // Data Ingestion
                const loadSources = async () => {
                    try {
                        const res = await fetch('/api/sources');
                        ingestionSources.value = await res.json();
                    } catch (e) { console.error('Error loading sources:', e); }
                };

                const runIngestion = async (sourceId) => {
                    ingestionStatus.value[sourceId] = { loading: true, message: 'Ingesting...' };
                    try {
                        const res = await fetch('/api/ingest', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ source: sourceId, limit: 100 })
                        });
                        const data = await res.json();
                        ingestionStatus.value[sourceId] = {
                            loading: false,
                            message: data.error || `Ingested ${data.count} memories`,
                            success: !data.error
                        };
                        loadStats();
                        loadMemories(true);
                    } catch (e) {
                        ingestionStatus.value[sourceId] = { loading: false, message: 'Error: ' + e.message, success: false };
                    }
                };

                // Knowledge Synthesis
                const runSynthesis = async () => {
                    synthesisLoading.value = true;
                    synthesisResult.value = null;
                    try {
                        const res = await fetch('/api/synthesis');
                        synthesisResult.value = await res.json();
                    } catch (e) {
                        synthesisResult.value = { error: e.message };
                    } finally {
                        synthesisLoading.value = false;
                    }
                };

                // LLM Management
                const loadLLMs = async () => {
                    try {
                        const res = await fetch('/api/llms');
                        llmModels.value = await res.json();
                    } catch (e) { console.error('Error loading LLMs:', e); }
                };

                const saveLLM = async () => {
                    try {
                        const res = await fetch('/api/llms', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newLLM)
                        });
                        if (res.ok) {
                            showAddLLMModal.value = false;
                            Object.assign(newLLM, { name: '', provider: '', model: '', api_key: '', base_url: '', description: '' });
                            await loadLLMs();
                            await loadProviders();
                        }
                    } catch (e) { console.error('Error saving LLM:', e); }
                };

                const toggleLLM = async (llm) => {
                    try {
                        await fetch(`/api/llms/${llm.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ enabled: !llm.enabled })
                        });
                        await loadLLMs();
                        await loadProviders();
                    } catch (e) { console.error('Error toggling LLM:', e); }
                };

                const deleteLLM = async (llm) => {
                    if (!confirm(`Delete "${llm.name}"?`)) return;
                    try {
                        await fetch(`/api/llms/${llm.id}`, { method: 'DELETE' });
                        await loadLLMs();
                        await loadProviders();
                    } catch (e) { console.error('Error deleting LLM:', e); }
                };

                const testLLM = async (llm) => {
                    showTestResult.value = true;
                    testResult.value = { loading: true };
                    try {
                        const res = await fetch(`/api/llms/${llm.id}/test`, { method: 'POST' });
                        const data = await res.json();
                        testResult.value = data;
                    } catch (e) {
                        testResult.value = { success: false, error: e.message };
                    }
                };

                const getLLMIcon = (provider) => {
                    const icons = {
                        'anthropic': 'fas fa-robot',
                        'openai': 'fas fa-brain',
                        'google': 'fab fa-google',
                        'cohere': 'fas fa-atom',
                        'mistral': 'fas fa-wind',
                        'bedrock': 'fab fa-aws',
                        'azure': 'fab fa-microsoft',
                        'custom': 'fas fa-cog',
                        'claude': 'fas fa-robot',
                        'chatgpt': 'fas fa-brain',
                        'copilot': 'fab fa-github',
                        'amazonq': 'fab fa-aws'
                    };
                    return icons[provider] || 'fas fa-cloud';
                };

                const editLLM = (llm) => {
                    editingLLM.value = { ...llm, api_key: '' };
                    showEditLLMModal.value = true;
                };

                const updateLLM = async () => {
                    if (!editingLLM.value) return;
                    try {
                        const res = await fetch(`/api/llms/${editingLLM.value.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: editingLLM.value.name,
                                model: editingLLM.value.model,
                                api_key: editingLLM.value.api_key || undefined,
                                base_url: editingLLM.value.base_url,
                                description: editingLLM.value.description,
                                enabled: editingLLM.value.enabled
                            })
                        });
                        if (res.ok) {
                            showEditLLMModal.value = false;
                            editingLLM.value = null;
                            await loadLLMs();
                            await loadProviders();
                        }
                    } catch (e) { console.error('Error updating LLM:', e); }
                };

                // SLM Management
                const loadSLMs = async () => {
                    try {
                        const res = await fetch('/api/slms');
                        slmModels.value = await res.json();
                    } catch (e) { console.error('Error loading SLMs:', e); }
                };

                const saveSLM = async () => {
                    try {
                        const res = await fetch('/api/slms', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newSLM)
                        });
                        if (res.ok) {
                            showAddSLMModal.value = false;
                            Object.assign(newSLM, { name: '', runtime: '', model: '', endpoint: '' });
                            await loadSLMs();
                            await loadProviders();
                        }
                    } catch (e) { console.error('Error saving SLM:', e); }
                };

                const toggleSLM = async (slm) => {
                    try {
                        await fetch(`/api/slms/${slm.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ enabled: !slm.enabled })
                        });
                        await loadSLMs();
                        await loadProviders();
                    } catch (e) { console.error('Error toggling SLM:', e); }
                };

                const deleteSLM = async (slm) => {
                    if (!confirm(`Delete "${slm.name}"?`)) return;
                    try {
                        await fetch(`/api/slms/${slm.id}`, { method: 'DELETE' });
                        await loadSLMs();
                        await loadProviders();
                    } catch (e) { console.error('Error deleting SLM:', e); }
                };

                const testSLM = async (slm) => {
                    showTestResult.value = true;
                    testResult.value = { loading: true };
                    try {
                        const res = await fetch(`/api/slms/${slm.id}/test`, { method: 'POST' });
                        const data = await res.json();
                        testResult.value = data;
                    } catch (e) {
                        testResult.value = { success: false, error: e.message };
                    }
                };

                const editSLM = (slm) => {
                    editingSLM.value = { ...slm };
                    showEditSLMModal.value = true;
                };

                const updateSLM = async () => {
                    if (!editingSLM.value) return;
                    try {
                        const res = await fetch(`/api/slms/${editingSLM.value.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: editingSLM.value.name,
                                runtime: editingSLM.value.runtime,
                                model: editingSLM.value.model,
                                endpoint: editingSLM.value.endpoint,
                                enabled: editingSLM.value.enabled
                            })
                        });
                        if (res.ok) {
                            showEditSLMModal.value = false;
                            editingSLM.value = null;
                            await loadSLMs();
                            await loadProviders();
                        }
                    } catch (e) { console.error('Error updating SLM:', e); }
                };

                const getSLMIcon = (runtime) => {
                    const icons = {
                        'ollama': 'fas fa-server',
                        'lmstudio': 'fas fa-desktop',
                        'llamacpp': 'fas fa-terminal',
                        'vllm': 'fas fa-bolt',
                        'custom': 'fas fa-cog'
                    };
                    return icons[runtime] || 'fas fa-microchip';
                };

                const refreshOllamaModels = async () => {
                    slmRefreshing.value = true;
                    try {
                        const res = await fetch('/api/slms/ollama/status');
                        const data = await res.json();
                        ollamaStatus.value = data;
                        if (data.running && data.models) {
                            // Auto-add any Ollama models that aren't already configured
                            ollamaModelsList.value = data.models;
                        }
                    } catch (e) {
                        ollamaStatus.value = { running: false, error: e.message };
                    } finally {
                        slmRefreshing.value = false;
                    }
                };

                const loadOllamaModelsList = async () => {
                    try {
                        const res = await fetch('/api/slms/ollama/models');
                        ollamaModelsList.value = await res.json();
                    } catch (e) { console.error('Error loading Ollama models:', e); }
                };

                const loadAvailableModels = async () => {
                    try {
                        const res = await fetch('/api/slms/ollama/available');
                        availableModels.value = await res.json();
                    } catch (e) { console.error('Error loading available models:', e); }
                };

                const pullOllamaModel = async (modelName) => {
                    pullingModels[modelName] = true;
                    try {
                        const res = await fetch('/api/slms/ollama/pull', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: modelName })
                        });
                        const data = await res.json();
                        if (data.success) {
                            await loadSLMs();
                            await loadAvailableModels();
                            await refreshOllamaModels();
                        } else {
                            alert('Failed to install model: ' + (data.error || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Error installing model: ' + e.message);
                    } finally {
                        delete pullingModels[modelName];
                    }
                };

                const deleteOllamaModel = async (modelName) => {
                    if (!confirm(`Delete model "${modelName}"? This will remove the model files from disk.`)) return;
                    try {
                        const res = await fetch(`/api/slms/ollama/${encodeURIComponent(modelName)}`, { method: 'DELETE' });
                        const data = await res.json();
                        if (data.success) {
                            await loadSLMs();
                            await loadAvailableModels();
                            await refreshOllamaModels();
                        } else {
                            alert('Failed to delete model: ' + (data.error || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Error deleting model: ' + e.message);
                    }
                };

                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    const d = new Date(dateStr);
                    return d.toLocaleDateString();
                };

                const formatSize = (bytes) => {
                    if (!bytes) return '';
                    const gb = bytes / (1024 * 1024 * 1024);
                    return gb >= 1 ? `${gb.toFixed(1)} GB` : `${(bytes / (1024 * 1024)).toFixed(0)} MB`;
                };

                const getConnectionIcon = (type) => {
                    const icons = {
                        'gmail': 'fas fa-envelope',
                        'chrome_history': 'fab fa-chrome',
                        'safari_history': 'fab fa-safari',
                        'imessage': 'fas fa-comment-dots',
                        'local_git': 'fab fa-git-alt',
                        'claude_code': 'fas fa-robot',
                        'twitter': 'fab fa-twitter',
                        'linkedin': 'fab fa-linkedin',
                        'facebook': 'fab fa-facebook',
                        'slack': 'fab fa-slack',
                        'notion': 'fas fa-book',
                        'google_drive': 'fab fa-google-drive',
                        'dropbox': 'fab fa-dropbox',
                        'github': 'fab fa-github'
                    };
                    return icons[type] || 'fas fa-database';
                };

                const performSearch = async () => {
                    if (!searchQuery.value) return;
                    // Set the memory search to match the global search
                    memorySearch.value = searchQuery.value;
                    // Switch to memories view
                    view.value = 'memories';
                    // Load memories (the filtering will happen via the computed property)
                    await loadMemories(true);
                };

                const viewMemory = (memory) => {
                    // Implement memory detail view
                    console.log('View memory:', memory);
                };

                const loadMoreMemories = () => {
                    // Implement pagination
                };

                // Auth Functions
                const checkAuth = async () => {
                    try {
                        const res = await fetch('/api/auth/status');
                        const data = await res.json();

                        if (data.authenticated) {
                            currentUser.value = data.user;
                            if (data.auth_state === 'mfa_setup') {
                                authState.value = 'mfa_setup';
                                await loadMfaSetup();
                            } else {
                                authState.value = 'authenticated';
                            }
                        } else {
                            authState.value = data.auth_state || 'login';
                        }
                    } catch (e) {
                        console.error('Auth check failed:', e);
                        authState.value = 'login';
                    }
                };

                const handleLogin = async () => {
                    authLoading.value = true;
                    authError.value = '';
                    try {
                        const res = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(loginForm)
                        });

                        if (!res.ok) {
                            const err = await res.json();
                            authError.value = err.detail || 'Login failed';
                            return;
                        }

                        const data = await res.json();
                        currentUser.value = data.user;

                        if (data.auth_state === 'mfa_setup') {
                            authState.value = 'mfa_setup';
                            await loadMfaSetup();
                        } else {
                            authState.value = 'authenticated';
                            initializeApp();
                        }
                    } catch (e) {
                        authError.value = 'Connection error. Please try again.';
                    } finally {
                        authLoading.value = false;
                    }
                };

                const loadMfaSetup = async () => {
                    try {
                        const res = await fetch('/api/auth/mfa/setup');
                        if (res.ok) {
                            const data = await res.json();
                            mfaSetup.secret = data.secret;
                            mfaSetup.qr_code_base64 = data.qr_code_base64;
                            mfaSetup.backup_codes = data.backup_codes;
                        }
                    } catch (e) {
                        console.error('Failed to load MFA setup:', e);
                    }
                };

                const verifyMfa = async () => {
                    authLoading.value = true;
                    authError.value = '';
                    try {
                        const res = await fetch('/api/auth/mfa/verify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ totp_code: mfaCode.value })
                        });

                        if (!res.ok) {
                            const err = await res.json();
                            authError.value = err.detail || 'Invalid code';
                            return;
                        }

                        const data = await res.json();
                        if (data.user) {
                            currentUser.value = data.user;
                        }
                        authState.value = 'authenticated';
                        mfaCode.value = '';
                        initializeApp();
                    } catch (e) {
                        authError.value = 'Verification failed. Please try again.';
                    } finally {
                        authLoading.value = false;
                    }
                };

                const handleLogout = async () => {
                    try {
                        await fetch('/api/auth/logout', { method: 'POST' });
                    } catch (e) {
                        console.error('Logout error:', e);
                    }
                    currentUser.value = null;
                    authState.value = 'login';
                    loginForm.username_or_email = '';
                    loginForm.password = '';
                };

                // Admin Functions
                const loadAdminUsers = async () => {
                    if (currentUser.value?.role !== 'admin') return;
                    try {
                        const res = await fetch('/api/admin/users');
                        if (res.ok) {
                            const data = await res.json();
                            adminUsers.value = data.users || [];
                        }
                    } catch (e) {
                        console.error('Failed to load users:', e);
                    }
                };

                const createUser = async () => {
                    try {
                        const res = await fetch('/api/admin/users', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newUserForm)
                        });
                        if (res.ok) {
                            showAddUserModal.value = false;
                            newUserForm.username = '';
                            newUserForm.email = '';
                            newUserForm.password = '';
                            newUserForm.role = 'user';
                            await loadAdminUsers();
                        } else {
                            const err = await res.json();
                            alert(err.detail || 'Failed to create user');
                        }
                    } catch (e) {
                        alert('Error creating user: ' + e.message);
                    }
                };

                const resetUserMfa = async (user) => {
                    if (!confirm(`Reset MFA for ${user.username}? They will need to set up MFA again on next login.`)) return;
                    try {
                        const res = await fetch(`/api/admin/users/${user.id}/reset-mfa`, { method: 'POST' });
                        if (res.ok) {
                            await loadAdminUsers();
                        } else {
                            const err = await res.json();
                            alert(err.detail || 'Failed to reset MFA');
                        }
                    } catch (e) {
                        alert('Error resetting MFA: ' + e.message);
                    }
                };

                const toggleUserStatus = async (user) => {
                    const action = user.is_active ? 'deactivate' : 'activate';
                    if (!confirm(`Are you sure you want to ${action} ${user.username}?`)) return;
                    try {
                        const res = await fetch(`/api/admin/users/${user.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ is_active: !user.is_active })
                        });
                        if (res.ok) {
                            await loadAdminUsers();
                        } else {
                            const err = await res.json();
                            alert(err.detail || `Failed to ${action} user`);
                        }
                    } catch (e) {
                        alert(`Error ${action}ing user: ` + e.message);
                    }
                };

                const changePassword = async () => {
                    passwordError.value = '';
                    passwordSuccess.value = false;

                    if (passwordForm.new !== passwordForm.confirm) {
                        passwordError.value = 'New passwords do not match';
                        return;
                    }
                    if (passwordForm.new.length < 8) {
                        passwordError.value = 'Password must be at least 8 characters';
                        return;
                    }

                    try {
                        const res = await fetch(`/api/auth/change-password?current_password=${encodeURIComponent(passwordForm.current)}&new_password=${encodeURIComponent(passwordForm.new)}`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            passwordSuccess.value = true;
                            passwordForm.current = '';
                            passwordForm.new = '';
                            passwordForm.confirm = '';
                            setTimeout(() => {
                                showChangePasswordModal.value = false;
                                passwordSuccess.value = false;
                            }, 2000);
                        } else {
                            const err = await res.json();
                            passwordError.value = err.detail || 'Failed to change password';
                        }
                    } catch (e) {
                        passwordError.value = 'Error changing password: ' + e.message;
                    }
                };

                // Edit User Functions
                const openEditUser = (user) => {
                    editUserForm.id = user.id;
                    editUserForm.username = user.username;
                    editUserForm.email = user.email;
                    editUserForm.role = user.role;
                    editUserForm.is_active = user.is_active;
                    editUserNewPassword.value = '';
                    editUserError.value = '';
                    editUserSuccess.value = '';
                    showEditUserModal.value = true;
                };

                const closeEditUserModal = () => {
                    showEditUserModal.value = false;
                    editUserError.value = '';
                    editUserSuccess.value = '';
                    editUserNewPassword.value = '';
                };

                const saveUserChanges = async () => {
                    editUserError.value = '';
                    editUserSuccess.value = '';
                    try {
                        const res = await fetch(`/api/admin/users/${editUserForm.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: editUserForm.email,
                                role: editUserForm.id !== currentUser.value?.id ? editUserForm.role : undefined
                            })
                        });
                        if (res.ok) {
                            editUserSuccess.value = 'User updated successfully';
                            await loadAdminUsers();
                            setTimeout(() => editUserSuccess.value = '', 3000);
                        } else {
                            const err = await res.json();
                            editUserError.value = err.detail || 'Failed to update user';
                        }
                    } catch (e) {
                        editUserError.value = 'Error updating user: ' + e.message;
                    }
                };

                const resetUserPassword = async () => {
                    if (!editUserNewPassword.value || editUserNewPassword.value.length < 8) {
                        editUserError.value = 'Password must be at least 8 characters';
                        return;
                    }
                    editUserError.value = '';
                    editUserSuccess.value = '';
                    try {
                        const res = await fetch(`/api/admin/users/${editUserForm.id}/reset-password?new_password=${encodeURIComponent(editUserNewPassword.value)}`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            editUserSuccess.value = 'Password reset successfully';
                            editUserNewPassword.value = '';
                            setTimeout(() => editUserSuccess.value = '', 3000);
                        } else {
                            const err = await res.json();
                            editUserError.value = err.detail || 'Failed to reset password';
                        }
                    } catch (e) {
                        editUserError.value = 'Error resetting password: ' + e.message;
                    }
                };

                const resetEditUserMfa = async () => {
                    if (!confirm(`Reset MFA for ${editUserForm.username}? They will need to set up MFA again on next login.`)) return;
                    editUserError.value = '';
                    editUserSuccess.value = '';
                    try {
                        const res = await fetch(`/api/admin/users/${editUserForm.id}/reset-mfa`, { method: 'POST' });
                        if (res.ok) {
                            editUserSuccess.value = 'MFA reset successfully';
                            await loadAdminUsers();
                            // Update local form state
                            editUserForm.mfa_enabled = false;
                            setTimeout(() => editUserSuccess.value = '', 3000);
                        } else {
                            const err = await res.json();
                            editUserError.value = err.detail || 'Failed to reset MFA';
                        }
                    } catch (e) {
                        editUserError.value = 'Error resetting MFA: ' + e.message;
                    }
                };

                const toggleEditUserStatus = async () => {
                    const action = editUserForm.is_active ? 'deactivate' : 'activate';
                    if (!confirm(`Are you sure you want to ${action} ${editUserForm.username}?`)) return;
                    editUserError.value = '';
                    editUserSuccess.value = '';
                    try {
                        const res = await fetch(`/api/admin/users/${editUserForm.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ is_active: !editUserForm.is_active })
                        });
                        if (res.ok) {
                            editUserForm.is_active = !editUserForm.is_active;
                            editUserSuccess.value = `User ${action}d successfully`;
                            await loadAdminUsers();
                            setTimeout(() => editUserSuccess.value = '', 3000);
                        } else {
                            const err = await res.json();
                            editUserError.value = err.detail || `Failed to ${action} user`;
                        }
                    } catch (e) {
                        editUserError.value = `Error ${action}ing user: ` + e.message;
                    }
                };

                // Help System Functions
                const openHelp = async (pageId = 'getting_started') => {
                    showHelpModal.value = true;
                    await loadHelpPages();
                    await loadHelpPage(pageId);
                };

                const loadHelpPages = async () => {
                    try {
                        const res = await fetch('/api/help');
                        if (res.ok) {
                            const data = await res.json();
                            helpPages.value = data.pages;
                        }
                    } catch (e) {
                        console.error('Failed to load help pages:', e);
                    }
                };

                const loadHelpPage = async (pageId) => {
                    helpLoading.value = true;
                    try {
                        const res = await fetch(`/api/help/${pageId}`);
                        if (res.ok) {
                            const data = await res.json();
                            currentHelpPage.value = {
                                ...data,
                                html: marked.parse(data.content)
                            };
                        }
                    } catch (e) {
                        console.error('Failed to load help page:', e);
                    } finally {
                        helpLoading.value = false;
                    }
                };

                const closeHelp = () => {
                    showHelpModal.value = false;
                };

                const initializeApp = () => {
                    loadStats();
                    loadMemories();
                    loadConnections();
                    loadProviders();
                    loadLLMs();
                    loadSLMs();
                    refreshOllamaModels();
                    loadAvailableModels();
                    // Load admin users if user is admin
                    if (currentUser.value?.role === 'admin') {
                        loadAdminUsers();
                    }
                };

                // Watch view changes to load admin users when navigating to admin view
                watch(view, (newView) => {
                    if (newView === 'admin' && currentUser.value?.role === 'admin') {
                        loadAdminUsers();
                    }
                });

                // Initialize
                onMounted(async () => {
                    await checkAuth();
                    if (authState.value === 'authenticated') {
                        initializeApp();
                    }
                });

                return {
                    // Auth
                    authState, authLoading, authError, currentUser, showUserMenu, loginForm, mfaSetup, mfaCode,
                    handleLogin, handleLogout, verifyMfa,
                    // Admin
                    adminUsers, showAddUserModal, newUserForm,
                    loadAdminUsers, createUser, resetUserMfa, toggleUserStatus,
                    // Password Change
                    showChangePasswordModal, passwordForm, passwordError, passwordSuccess, changePassword,
                    // Edit User
                    showEditUserModal, editUserForm, editUserNewPassword, editUserError, editUserSuccess,
                    openEditUser, closeEditUserModal, saveUserChanges, resetUserPassword, resetEditUserMfa, toggleEditUserStatus,
                    // Help System
                    showHelpModal, helpPages, currentHelpPage, helpLoading,
                    openHelp, loadHelpPage, closeHelp,
                    // App
                    view, searchQuery, stats, memories, connections, showAddModal,
                    filterTier, filterType, filterDomain, memorySearch,
                    topDomains, filteredMemories,
                    // Pagination
                    currentPage, pageSize, totalMemories, memoriesLoading,
                    totalPages, showingFrom, showingTo, pageNumbers,
                    goToPage, prevPage, nextPage, changePageSize,
                    // Chat
                    chatTab, conversations, selectedConversation,
                    chatMessages, newMessage, compareProviders, compareQuery, compareMaxMemories,
                    compareResults, comparing, showFullContext, newMemory, newTag,
                    selectedLLM, availableLLMs, chatLoading,
                    // Tool modals
                    showContextGenerator, showIngestion, showSynthesis,
                    generatedContext, contextLoading, contextMaxMemories,
                    ingestionSources, ingestionStatus, synthesisResult, synthesisLoading,
                    generateContext, copyContext, loadSources, runIngestion, runSynthesis,
                    // LLM/SLM Management
                    llmModels, slmModels, showAddLLMModal, showAddSLMModal,
                    showEditLLMModal, editingLLM,
                    newLLM, newSLM, ollamaStatus, ollamaModelsList, slmRefreshing,
                    showTestResult, testResult,
                    loadLLMs, saveLLM, toggleLLM, deleteLLM, testLLM, getLLMIcon,
                    editLLM, updateLLM,
                    loadSLMs, saveSLM, toggleSLM, deleteSLM, testSLM, getSLMIcon,
                    editSLM, updateSLM, showEditSLMModal, editingSLM,
                    refreshOllamaModels, loadOllamaModelsList,
                    availableModels, pullingModels, loadAvailableModels, pullOllamaModel, deleteOllamaModel,
                    modelCategory, filteredAvailableModels,
                    // Methods
                    loadStats, loadMemories, loadConnections, runComparison, selectConversation,
                    sendMessage, saveMemory, addTag, formatDate, formatSize, getConnectionIcon, performSearch,
                    viewMemory, filterMemories, setDomainFilter, setTierFilter
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
